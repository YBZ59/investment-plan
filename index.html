<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investment AI System - Technical Roadmap</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Chart.js for MVP Plan -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0b1121;
            color: #e2e8f0;
            background-image: radial-gradient(circle at 50% 0%, #1e293b 0%, #0b1121 70%);
        }

        .gradient-text {
            background: linear-gradient(to right, #60a5fa, #c084fc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Glassmorphism & Cards */
        .card, .glass-card {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(148, 163, 184, 0.1);
            transition: all 0.3s ease;
            border-radius: 1rem;
        }

        .card:hover, .glass-card:hover {
            border-color: rgba(96, 165, 250, 0.4);
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.5);
            transform: translateY(-2px);
        }

        .chart-container {
            position: relative;
            width: 100%;
            height: 300px;
        }

        .tech-pill {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.2);
            font-family: 'Courier New', monospace;
        }

        /* Buttons & Toggles */
        .btn-toggle { transition: all 0.3s ease; }
        .btn-toggle.active { background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%); color: white; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4); border: none; }
        .btn-toggle.inactive { background-color: transparent; color: #94a3b8; border: 1px solid #334155; }
        .btn-toggle.inactive:hover { border-color: #64748b; color: #cbd5e1; }

        /* Special Button Colors */
        .btn-r-native.active { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .btn-ui-journey.active { background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); }
        .btn-biz-process.active { background: linear-gradient(135deg, #6366f1 0%, #4338ca 100%); }
        .btn-arch-comp.active { background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%); }
        .btn-cost.active { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .btn-infographic.active { background: linear-gradient(135deg, #db2777 0%, #be185d 100%); }
        .btn-lifecycle.active { background: linear-gradient(135deg, #a855f7 0%, #7e22ce 100%); }
        .btn-database.active { background: linear-gradient(135deg, #ea580c 0%, #c2410c 100%); }

        /* Animation classes */
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Flow Diagram & Packets */
        .flow-arrow-container { display: flex; flex-direction: column; align-items: center; justify-content: center; min-width: 40px; padding: 0 2px; }
        .flow-line { height: 2px; background: #475569; width: 100%; position: relative; }
        .flow-line::after { content: ''; position: absolute; right: 0; top: -4px; border-top: 5px solid transparent; border-bottom: 5px solid transparent; border-left: 6px solid #475569; }
        .flow-action-label { font-size: 0.6rem; color: #60a5fa; background: #0f172a; padding: 2px 4px; border: 1px solid #334155; border-radius: 10px; margin-bottom: -9px; z-index: 20; white-space: nowrap; }

        /* Packet Animation */
        @keyframes movePacket { 0% { left: 0%; opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { left: 100%; opacity: 0; } }
        .flow-packet { position: absolute; top: -4px; width: 0; height: 0; border-top: 5px solid transparent; border-bottom: 5px solid transparent; border-left: 8px solid #60a5fa; background-color: transparent; z-index: 5; animation: movePacket 2s infinite linear; }
        .flow-packet.purple { border-left-color: #a855f7; }
        .flow-packet.green { border-left-color: #22c55e; }
        .flow-packet.indigo { border-left-color: #6366f1; }

        /* Diff Engine Animation */
        @keyframes slideRight { 0% { transform: translateX(-10px); opacity: 0; } 50% { opacity: 1; } 100% { transform: translateX(10px); opacity: 0; } }
        @keyframes slideLeft { 0% { transform: translateX(10px); opacity: 0; } 50% { opacity: 1; } 100% { transform: translateX(-10px); opacity: 0; } }
        .anim-diff-r { animation: slideRight 2s infinite ease-in-out; }
        .anim-diff-l { animation: slideLeft 2s infinite ease-in-out; }

        /* UI Mock Elements */
        .app-window { background: #0f172a; border: 1px solid #334155; border-radius: 12px; overflow: hidden; display: flex; min-height: 600px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3); }
        .app-sidebar { width: 200px; background: #1e293b; border-right: 1px solid #334155; padding: 20px 10px; flex-shrink: 0; display: flex; flex-direction: column; }
        .app-nav-item { display: flex; align-items: center; gap: 10px; padding: 10px; color: #94a3b8; font-size: 0.8rem; border-radius: 6px; margin-bottom: 4px; cursor: pointer; transition: all 0.2s; }
        .app-nav-item:hover { background: rgba(51, 65, 85, 0.5); color: #cbd5e1; }
        .app-nav-item.active { background: #334155; color: #fff; font-weight: 600; border-left: 3px solid #38bdf8; }
        .app-content { flex-grow: 1; padding: 30px; background: radial-gradient(circle at 10% 10%, #1e293b 0%, #0f172a 100%); overflow-x: auto; position: relative; }

        /* Mock Table */
        .mock-table { width: 100%; font-size: 0.65rem; color: #cbd5e1; border-collapse: collapse; }
        .mock-table th { text-align: left; padding: 6px; border-bottom: 1px solid #475569; color: #64748b; }
        .mock-table td { padding: 6px; border-bottom: 1px solid #334155; vertical-align: middle; }
        .mock-table tr:hover { background: rgba(51, 65, 85, 0.3); }
        .mock-btn-sm { padding: 2px 6px; border-radius: 4px; font-size: 0.6rem; cursor: pointer; display: inline-block; margin-right: 4px; }
        .btn-green { background: rgba(16, 185, 129, 0.2); color: #34d399; border: 1px solid rgba(16, 185, 129, 0.4); }
        .btn-blue { background: rgba(59, 130, 246, 0.2); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.4); }
        .btn-red { background: rgba(239, 68, 68, 0.2); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.4); }
        .btn-purple { background: rgba(147, 51, 234, 0.2); color: #c084fc; border: 1px solid rgba(147, 51, 234, 0.4); }
        .btn-gray { background: rgba(148, 163, 184, 0.1); color: #94a3b8; border: 1px solid #475569; cursor: not-allowed; }

        /* Charts & Data Sheet */
        .pie-chart { width: 80px; height: 80px; border-radius: 50%; background: conic-gradient(#3b82f6 0% 70%, #10b981 70% 90%, #f59e0b 90% 100%); }
        .chart-bar { width: 12px; background: #3b82f6; border-radius: 2px 2px 0 0; margin: 0 4px; }
        .ds-table { width: 100%; border-collapse: collapse; font-size: 0.7rem; color: #e2e8f0; }
        .ds-table th { background: #1e293b; padding: 8px; text-align: left; border: 1px solid #334155; }
        .ds-table td { padding: 8px; border: 1px solid #334155; background: #0f172a; }
        .ds-cell-calc { color: #60a5fa; font-weight: 600; background: rgba(59, 130, 246, 0.1) !important; cursor: pointer; }
        .ds-cell-calc:hover { background: rgba(59, 130, 246, 0.3) !important; }
        .ds-cell-manual { color: #fff; }
        /* FIXED: DS Input styling */
        .ds-input { background-color: transparent !important; border: 1px solid transparent; color: #e2e8f0; width: 100%; outline: none; }
        .ds-input.editing { border: 1px solid #3b82f6; background-color: #1e293b !important; padding: 2px; }

        /* Flow Cards & Windows */
        .flow-card { background: #1e293b; border: 1px solid #475569; border-radius: 8px; padding: 10px; width: 130px; min-height: 90px; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; position: relative; z-index: 10; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.3); }
        .flow-card-title { font-size: 0.65rem; color: #94a3b8; text-transform: uppercase; font-weight: 700; margin-bottom: 6px; letter-spacing: 0.5px; }
        .mock-window-sm { background: #0f172a; border: 1px solid #475569; border-radius: 6px; width: 100%; height: 100%; overflow: hidden; display: flex; flex-direction: column; }
        .mock-header-sm { background: #334155; height: 10px; border-bottom: 1px solid #475569; display: flex; align-items: center; padding: 0 4px; gap: 2px; }
        .mock-dot-sm { width: 3px; height: 3px; border-radius: 50%; background: #64748b; }
        
        /* Infographic Steps */
        .flow-step { position: relative; z-index: 10; }
        
        /* Toast & Modal */
        #toast-notification {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: #1e293b; border: 1px solid #60a5fa; color: white;
            padding: 10px 20px; rounded: 8px; font-size: 0.8rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            z-index: 100; display: none; opacity: 0; transition: opacity 0.3s;
        }
        #custom-confirm-modal {
            background: rgba(15, 23, 42, 0.95);
            z-index: 60;
        }
        
        /* Animations for KPI */
        @keyframes kpiPulse {
            0% { transform: scale(1); color: white; }
            50% { transform: scale(1.3); color: #4ade80; }
            100% { transform: scale(1); color: white; }
        }
        .kpi-update {
            animation: kpiPulse 0.6s ease-in-out;
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <!-- Header -->
    <header class="max-w-6xl mx-auto mb-10 text-center relative">
        <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-blue-900/20 border border-blue-500/20 text-blue-300 text-xs font-semibold mb-4 tracking-wider uppercase">
            <span class="w-2 h-2 rounded-full bg-blue-400 animate-pulse"></span>
            System Architecture 1.0
        </div>
        <h1 class="text-4xl md:text-5xl font-bold mb-4 gradient-text">MORE Compliance Report Generator</h1>
        <p class="text-slate-400 max-w-2xl mx-auto text-lg">
            Automated Analysis of TASE & Treasury Regulations
        </p>

        <!-- View Toggles -->
        <div class="flex flex-wrap justify-center gap-4 mt-8">
            <button onclick="switchView('biz-process')" id="btn-biz-process" class="btn-toggle btn-biz-process active px-6 py-3 rounded-xl font-semibold flex items-center gap-2">
                <i class="fas fa-cogs"></i> Business Process
            </button>
            <button onclick="switchView('ui-journey')" id="btn-ui-journey" class="btn-toggle btn-ui-journey inactive px-6 py-3 rounded-xl font-semibold flex items-center gap-2">
                <i class="fas fa-laptop-medical"></i> UI Journey
            </button>
            <button onclick="switchView('lifecycle')" id="btn-lifecycle" class="btn-toggle btn-lifecycle inactive px-6 py-3 rounded-xl font-semibold flex items-center gap-2">
                <i class="fas fa-sync-alt"></i> Report Lifecycle
            </button>
            <button onclick="switchView('database')" id="btn-database" class="btn-toggle btn-database inactive px-6 py-3 rounded-xl font-semibold flex items-center gap-2">
                <i class="fas fa-database"></i> Data Structure
            </button>
            <button onclick="switchView('tech')" id="btn-tech" class="btn-toggle inactive px-6 py-3 rounded-xl font-semibold flex items-center gap-2">
                <i class="fas fa-server"></i> Technical Deep Dive
            </button>
            <button onclick="switchView('deployment')" id="btn-deployment" class="btn-toggle inactive px-6 py-3 rounded-xl font-semibold flex items-center gap-2">
                <i class="fas fa-server"></i> Deployment & Scale
            </button>
            <button onclick="switchView('security')" id="btn-security" class="btn-toggle inactive px-6 py-3 rounded-xl font-semibold flex items-center gap-2">
                <i class="fas fa-shield-alt"></i> Security
            </button>
            <button onclick="switchView('cost')" id="btn-cost" class="btn-toggle btn-cost inactive px-6 py-3 rounded-xl font-semibold flex items-center gap-2">
                <i class="fas fa-coins"></i> Cost Analysis
            </button>
            <button onclick="switchView('infographic')" id="btn-infographic" class="btn-toggle btn-infographic inactive px-6 py-3 rounded-xl font-semibold flex items-center gap-2">
                <i class="fas fa-project-diagram"></i> MVP Plan (8 Months)
            </button>
        </div>
    </header>

    <main class="max-w-6xl mx-auto relative min-h-[800px]">

        <!-- ========================================== -->
        <!-- BUSINESS PROCESS VIEW (E2E) - FIRST TAB    -->
        <!-- ========================================== -->
        <div id="view-biz-process" class="fade-in">
            <h2 class="text-2xl font-bold text-white mb-6 pl-2 border-l-4 border-indigo-500">End-to-End Business Logic & Infrastructure</h2>
            <p class="text-slate-400 mb-8 max-w-3xl">Operational flow: Ingesting previous reports with data sheets to generate new compliant submissions.</p>

            <div class="w-full overflow-x-auto p-4 bg-slate-800/30 rounded-2xl border border-indigo-500/30">
                <div class="min-w-0 w-full flex items-center justify-between gap-2"> 

                    <!-- 1. AUTH LAYER -->
                    <div class="flex flex-col items-center gap-2">
                        <div class="bg-indigo-900/40 border border-indigo-400 p-3 rounded-xl text-center w-28 shadow-lg shadow-indigo-500/20 relative">
                            <div class="absolute -top-3 left-1/2 -translate-x-1/2 bg-indigo-500 text-white text-[8px] px-2 rounded font-bold uppercase">Security</div>
                            <i class="fas fa-fingerprint text-2xl text-indigo-300 mb-2"></i>
                            <div class="text-[10px] font-bold text-white">Auth Layer</div>
                            <div class="text-[8px] text-indigo-200 mt-1">Supabase</div>
                        </div>
                    </div>

                    <!-- Connector -->
                    <div class="flow-arrow-container min-w-[30px]">
                        <div class="flow-action-label text-[9px]">Valid</div>
                        <div class="flow-line"><div class="flow-packet indigo"></div></div>
                    </div>

                    <!-- 2. CLOUD INFRASTRUCTURE WRAPPER -->
                    <div class="border-2 border-dashed border-slate-600 rounded-2xl p-3 bg-slate-900/40 relative flex items-center gap-3">
                        <div class="absolute -top-3 left-6 bg-slate-700 text-slate-300 text-[9px] px-2 py-0.5 rounded font-bold border border-slate-500 uppercase">
                            <i class="fas fa-cloud mr-1"></i> Cloud (Railway)
                        </div>

                        <!-- Inputs -->
                        <div class="flex flex-col gap-2">
                            <div class="bg-slate-800 border border-slate-600 p-2 rounded-lg w-32 flex items-center gap-2">
                                <div class="text-xl text-blue-400"><i class="fas fa-file-upload"></i></div>
                                <div>
                                    <div class="text-[8px] text-slate-400 uppercase font-bold">Ingest</div>
                                    <div class="text-[8px] text-white">Prev Report + Data Sheet</div>
                                </div>
                            </div>
                             <div class="bg-slate-800 border border-slate-600 p-2 rounded-lg w-32 flex items-center gap-2 opacity-70">
                                <div class="text-xl text-slate-500"><i class="fas fa-network-wired"></i></div>
                                <div>
                                    <div class="text-[8px] text-slate-500 uppercase font-bold">API</div>
                                    <div class="text-[9px] text-slate-400">Maya / ISA</div>
                                </div>
                            </div>
                        </div>

                        <!-- Internal Connector -->
                        <div class="flow-arrow-container min-w-[30px]">
                            <div class="flow-line"><div class="flow-packet indigo"></div></div>
                        </div>

                        <!-- Engine -->
                         <div class="bg-slate-800 border-2 border-indigo-500 rounded-xl p-3 text-center w-36 shadow-xl relative">
                            <i class="fas fa-sync text-2xl text-indigo-400 mb-2 animate-spin-slow" style="animation-duration: 10s;"></i>
                            <h4 class="text-white font-bold text-xs">Compliance Core</h4>
                            <p class="text-[8px] text-slate-400 mt-1">Smart Mapping & Overwrite</p>
                        </div>
                    </div>

                    <!-- Connector -->
                    <div class="flow-arrow-container min-w-[30px]">
                        <div class="flow-action-label text-[9px]">Draft</div>
                        <div class="flow-line"><div class="flow-packet indigo" style="animation-delay: 0.5s"></div></div>
                    </div>

                    <!-- 3. HUMAN REVIEW -->
                    <div class="flex flex-col gap-3 relative">
                        <div class="absolute -top-6 left-1/2 -translate-x-1/2 text-[9px] text-yellow-400 font-bold uppercase tracking-widest">Portal</div>
                        
                        <div class="bg-yellow-900/20 border border-yellow-500/50 p-2 rounded-lg w-36">
                            <div class="flex items-center gap-2 mb-1">
                                <i class="fas fa-user-edit text-yellow-400 text-sm"></i>
                                <span class="text-[10px] font-bold text-white">Analyst</span>
                            </div>
                            <p class="text-[8px] text-slate-400">Review Mapped Values</p>
                        </div>

                        <div class="bg-green-900/20 border border-green-500/50 p-2 rounded-lg w-36">
                            <div class="flex items-center gap-2 mb-1">
                                <i class="fas fa-user-check text-green-400 text-sm"></i>
                                <span class="text-[10px] font-bold text-white">Auditor</span>
                            </div>
                            <p class="text-[8px] text-slate-400">Validate & Sign</p>
                        </div>
                    </div>

                    <!-- Connector -->
                    <div class="flow-arrow-container min-w-[30px]">
                        <div class="flow-action-label text-[9px]">Sign</div>
                        <div class="flow-line"><div class="flow-packet green" style="animation-delay: 1s"></div></div>
                    </div>

                    <!-- 4. OUTPUT -->
                    <div class="bg-green-600 rounded-xl p-3 text-center w-28 shadow-lg shadow-green-500/20">
                        <i class="fas fa-file-signature text-white text-xl mb-1"></i>
                        <div class="text-white font-bold text-[10px]">Submission</div>
                        <div class="text-[8px] text-green-100 mt-1">Archive</div>
                    </div>

                </div>
            </div>
        </div>
        
        <!-- ========================================== -->
        <!-- REPORT LIFECYCLE VIEW                      -->
        <!-- ========================================== -->
        <div id="view-lifecycle" class="hidden">
             <h2 class="text-2xl font-bold text-white mb-6 pl-2 border-l-4 border-purple-500">Report Lifecycle & State Machine</h2>
             <p class="text-slate-400 mb-8 max-w-3xl">Visualizing the transition of a report from creation to final archive, and the triggers for each state.</p>

             <div class="bg-slate-900/50 border border-slate-700 rounded-2xl p-10 flex flex-col md:flex-row items-center justify-between gap-4 relative overflow-hidden">
                <!-- Background dashed line -->
                <div class="hidden md:block absolute top-1/2 left-10 right-10 h-0.5 bg-slate-700 border-t-2 border-dashed border-slate-600 z-0"></div>

                <!-- STATE 1: DRAFT -->
                <div class="relative z-10 flex flex-col items-center">
                    <div class="bg-yellow-900/20 border-2 border-yellow-500 p-6 rounded-2xl w-56 text-center shadow-lg shadow-yellow-500/10 backdrop-blur-sm">
                        <div class="w-12 h-12 bg-yellow-500 rounded-full flex items-center justify-center mx-auto mb-4 text-slate-900">
                            <i class="fas fa-file-pen text-xl"></i>
                        </div>
                        <h3 class="text-white font-bold text-lg mb-1">Draft</h3>
                        <p class="text-[10px] text-slate-400 mb-3">Created via Wizard OR Schedule.</p>
                        <div class="bg-slate-800 p-2 rounded border border-slate-600">
                            <div class="text-[9px] text-yellow-400 font-bold uppercase mb-1">Inputs</div>
                            <div class="flex justify-center gap-2 text-[8px] text-slate-400">
                                <span class="bg-slate-700 px-1 rounded">Template</span>
                                <span class="bg-slate-700 px-1 rounded">Data Sheet</span>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 md:absolute md:top-1/2 md:left-[22%] md:-translate-y-1/2 bg-purple-600/90 text-white text-[10px] font-bold px-3 py-1 rounded-full z-20 shadow-lg">
                        ACTION: GENERATE
                    </div>
                </div>

                <!-- STATE 2: GENERATED -->
                <div class="relative z-10 flex flex-col items-center">
                    <div class="bg-blue-900/20 border-2 border-blue-500 p-6 rounded-2xl w-56 text-center shadow-lg shadow-blue-500/10 backdrop-blur-sm">
                        <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center mx-auto mb-4 text-white">
                            <i class="fas fa-cog fa-spin text-xl"></i>
                        </div>
                        <h3 class="text-white font-bold text-lg mb-1">Generated</h3>
                        <p class="text-[10px] text-slate-400 mb-3">Calculated & Filled.</p>
                        <div class="bg-slate-800 p-2 rounded border border-slate-600">
                            <div class="text-[9px] text-blue-400 font-bold uppercase mb-1">Capabilities</div>
                            <div class="flex justify-center gap-2 text-[8px] text-slate-400">
                                <span class="bg-slate-700 px-1 rounded">Edit (Docs)</span>
                                <span class="bg-slate-700 px-1 rounded">Review</span>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 md:absolute md:top-1/2 md:right-[22%] md:-translate-y-1/2 bg-green-600/90 text-white text-[10px] font-bold px-3 py-1 rounded-full z-20 shadow-lg">
                        ACTION: SUBMIT
                    </div>
                </div>

                <!-- STATE 3: SUBMITTED -->
                <div class="relative z-10 flex flex-col items-center">
                    <div class="bg-green-900/20 border-2 border-green-500 p-6 rounded-2xl w-56 text-center shadow-lg shadow-green-500/10 backdrop-blur-sm">
                        <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-4 text-white">
                            <i class="fas fa-check-circle text-xl"></i>
                        </div>
                        <h3 class="text-white font-bold text-lg mb-1">Submitted</h3>
                        <p class="text-[10px] text-slate-400 mb-3">Locked & Archived.</p>
                        <div class="bg-slate-800 p-2 rounded border border-slate-600">
                            <div class="text-[9px] text-green-400 font-bold uppercase mb-1">Output</div>
                            <div class="flex justify-center gap-2 text-[8px] text-slate-400">
                                <span class="bg-slate-700 px-1 rounded">Repository</span>
                                <span class="bg-slate-700 px-1 rounded">Audit Log</span>
                            </div>
                        </div>
                    </div>
                </div>

             </div>

             <div class="grid grid-cols-2 gap-6 mt-8">
                 <div class="card p-6 bg-slate-800/50">
                     <h4 class="text-sm font-bold text-white mb-2"><i class="fas fa-random text-purple-400 mr-2"></i> Triggers</h4>
                     <ul class="text-xs text-slate-400 space-y-2">
                         <li><span class="text-yellow-400 font-bold">Manual:</span> "New Report" Wizard (First Time).</li>
                         <li><span class="text-yellow-400 font-bold">Scheduled:</span> System cron job creates Draft based on Frequency.</li>
                         <li><span class="text-blue-400 font-bold">Generation:</span> Runs Calc Engine, mapping Excel cells to PDF fields.</li>
                     </ul>
                 </div>
                 <div class="card p-6 bg-slate-800/50">
                     <h4 class="text-sm font-bold text-white mb-2"><i class="fas fa-lock text-green-400 mr-2"></i> Constraints</h4>
                     <ul class="text-xs text-slate-400 space-y-2">
                         <li><i class="fas fa-times-circle text-red-400 mr-1"></i> Cannot <strong>Edit</strong> a Submitted report.</li>
                         <li><i class="fas fa-times-circle text-red-400 mr-1"></i> Cannot <strong>Submit</strong> a Draft (must Generate first).</li>
                         <li><i class="fas fa-times-circle text-red-400 mr-1"></i> Deleting a Submitted report requires <strong>Admin</strong> privs.</li>
                     </ul>
                 </div>
             </div>
        </div>

        <!-- ========================================== -->
        <!-- DATABASE SCHEMA VIEW (NEW)                 -->
        <!-- ========================================== -->
        <div id="view-database" class="hidden">
            <h2 class="text-2xl font-bold text-white mb-6 pl-2 border-l-4 border-orange-500">PostgreSQL Schema & Data Model</h2>
            
            <!-- ERD Visualization -->
            <div class="bg-slate-800/40 p-8 rounded-xl border border-slate-700/50 mb-12 relative overflow-x-auto">
                <div class="flex flex-nowrap gap-8 min-w-[800px] justify-center items-start">
                    
                    <!-- Table: Regulations -->
                    <div class="bg-slate-900 border border-purple-500/50 rounded-lg w-48 shadow-lg">
                        <div class="bg-purple-900/30 p-2 border-b border-purple-500/30 font-bold text-xs text-purple-300">
                            <i class="fas fa-balance-scale mr-1"></i> regulations
                        </div>
                        <ul class="p-2 text-[10px] text-slate-300 font-mono space-y-1">
                            <li class="flex justify-between"><span>id</span> <span class="text-slate-500">PK</span></li>
                            <li>title</li>
                            <li>version</li>
                            <li>effective_date</li>
                            <li class="text-purple-400">extraction_json</li>
                        </ul>
                    </div>

                    <!-- Link -->
                    <div class="self-center w-8 h-0.5 bg-slate-600"></div>

                    <!-- Table: Templates -->
                    <div class="bg-slate-900 border border-blue-500/50 rounded-lg w-48 shadow-lg">
                        <div class="bg-blue-900/30 p-2 border-b border-blue-500/30 font-bold text-xs text-blue-300">
                            <i class="fas fa-layer-group mr-1"></i> templates
                        </div>
                        <ul class="p-2 text-[10px] text-slate-300 font-mono space-y-1">
                            <li class="flex justify-between"><span>id</span> <span class="text-slate-500">PK</span></li>
                            <li class="flex justify-between"><span>regulation_id</span> <span class="text-slate-500">FK</span></li>
                            <li>title</li>
                            <li class="text-blue-400">mapping_logic (JSON)</li>
                        </ul>
                    </div>

                    <!-- Link -->
                    <div class="self-center w-8 h-0.5 bg-slate-600"></div>

                    <!-- Table: Reports -->
                    <div class="bg-slate-900 border border-green-500/50 rounded-lg w-48 shadow-lg">
                        <div class="bg-green-900/30 p-2 border-b border-green-500/30 font-bold text-xs text-green-300">
                            <i class="fas fa-file-invoice mr-1"></i> reports
                        </div>
                        <ul class="p-2 text-[10px] text-slate-300 font-mono space-y-1">
                            <li class="flex justify-between"><span>id</span> <span class="text-slate-500">PK</span></li>
                            <li class="flex justify-between"><span>template_id</span> <span class="text-slate-500">FK</span></li>
                            <li class="flex justify-between"><span>data_sheet_id</span> <span class="text-slate-500">FK</span></li>
                            <li>status</li>
                            <li class="text-green-400 font-bold">frequency (Enum)</li>
                            <li>submission_date</li>
                        </ul>
                    </div>
                </div>
                
                <div class="flex flex-nowrap gap-8 min-w-[800px] justify-center items-start mt-8">
                     <!-- Table: Data Sheets -->
                    <div class="bg-slate-900 border border-yellow-500/50 rounded-lg w-48 shadow-lg relative left-12">
                        <div class="bg-yellow-900/30 p-2 border-b border-yellow-500/30 font-bold text-xs text-yellow-300">
                            <i class="fas fa-table mr-1"></i> data_sheets
                        </div>
                        <ul class="p-2 text-[10px] text-slate-300 font-mono space-y-1">
                            <li class="flex justify-between"><span>id</span> <span class="text-slate-500">PK</span></li>
                            <li>filename</li>
                            <li>s3_key</li>
                            <li class="text-yellow-400">parsed_data (JSON)</li>
                        </ul>
                    </div>

                    <!-- Link Vertical (Simulated) -->
                    <div class="self-center w-8 h-0.5 bg-transparent"></div>

                     <!-- Table: Audit Logs -->
                     <div class="bg-slate-900 border border-slate-500/50 rounded-lg w-48 shadow-lg relative left-24">
                        <div class="bg-slate-800 p-2 border-b border-slate-500/30 font-bold text-xs text-slate-300">
                            <i class="fas fa-history mr-1"></i> audit_logs
                        </div>
                        <ul class="p-2 text-[10px] text-slate-300 font-mono space-y-1">
                            <li class="flex justify-between"><span>id</span> <span class="text-slate-500">PK</span></li>
                            <li>user_id</li>
                            <li>action</li>
                            <li>resource_id</li>
                            <li>changes (JSON)</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Detailed Definitions -->
            <div class="grid md:grid-cols-2 gap-8">
                <div>
                    <h3 class="text-lg font-bold text-white mb-4">Core Tables</h3>
                    <div class="space-y-4">
                        <div class="bg-slate-900 p-4 rounded-lg border border-slate-700">
                            <div class="text-sm font-bold text-purple-400 mb-2">regulations</div>
                            <p class="text-xs text-slate-400 mb-2">Stores the raw and processed regulatory text. `extraction_json` holds the AI-parsed rules and formulas.</p>
                        </div>
                        <div class="bg-slate-900 p-4 rounded-lg border border-slate-700">
                            <div class="text-sm font-bold text-blue-400 mb-2">templates</div>
                            <p class="text-xs text-slate-400 mb-2">Defines the structure of the output PDF. `mapping_logic` is a JSONB object linking Excel Cell Coordinates (e.g., "Sheet1!A1") to Report Fields.</p>
                        </div>
                        <div class="bg-slate-900 p-4 rounded-lg border border-slate-700">
                            <div class="text-sm font-bold text-green-400 mb-2">reports</div>
                            <p class="text-xs text-slate-400 mb-2">The central entity. Tracks lifecycle (Draft/Generated/Submitted). `frequency` column determines scheduling (e.g. 'Monthly').</p>
                        </div>
                    </div>
                </div>
                <div>
                    <h3 class="text-lg font-bold text-white mb-4">Supporting Data</h3>
                     <div class="space-y-4">
                        <div class="bg-slate-900 p-4 rounded-lg border border-slate-700">
                            <div class="text-sm font-bold text-yellow-400 mb-2">data_sheets</div>
                            <p class="text-xs text-slate-400 mb-2">Stores metadata about uploaded Excel files. `parsed_data` caches the raw values extracted from the sheet to avoid re-parsing.</p>
                        </div>
                        <div class="bg-slate-900 p-4 rounded-lg border border-slate-700">
                            <div class="text-sm font-bold text-slate-300 mb-2">audit_logs</div>
                            <p class="text-xs text-slate-400 mb-2">Immutable record of all write actions. Critical for compliance. Tracks "Who changed What and When".</p>
                        </div>
                        <div class="bg-slate-900 p-4 rounded-lg border border-slate-700">
                            <div class="text-sm font-bold text-slate-300 mb-2">users</div>
                            <p class="text-xs text-slate-400 mb-2">Managed via Supabase Auth, but mirrored here for Role-Based Access Control (RBAC) assignments.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========================================== -->
        <!-- UI JOURNEY VIEW (INTERACTIVE APP MOCK)     -->
        <!-- ========================================== -->
        <div id="view-ui-journey" class="hidden">
             <h2 class="text-2xl font-bold text-white mb-6 pl-2 border-l-4 border-cyan-500">Interactive Application Walkthrough</h2>
             <p class="text-slate-400 mb-6 max-w-3xl">Click on the sidebar items in the preview below to see the user journey for each module.</p>
             <div class="app-window relative">
                 
                 <!-- GLOBAL TOAST -->
                 <div id="toast-notification">Notification Message</div>

                 <!-- CUSTOM CONFIRM MODAL -->
                 <div id="custom-confirm-modal" class="hidden absolute inset-0 flex items-center justify-center fade-in">
                     <div class="bg-slate-800 border border-slate-600 p-6 rounded-xl shadow-2xl w-80 text-center">
                         <i class="fas fa-exclamation-triangle text-yellow-400 text-2xl mb-3" id="confirm-icon"></i>
                         <h4 class="text-white font-bold text-sm mb-2" id="confirm-title">Confirm Action</h4>
                         <p class="text-xs text-slate-400 mb-6" id="confirm-msg">Are you sure?</p>
                         <div class="flex justify-center gap-3">
                             <button class="px-4 py-2 rounded text-xs bg-slate-700 text-white hover:bg-slate-600" onclick="closeConfirmModal()">Cancel</button>
                             <button class="px-4 py-2 rounded text-xs bg-red-600 text-white hover:bg-red-500 transition" id="confirm-btn-action">Confirm</button>
                         </div>
                     </div>
                 </div>

                 <!-- REPORT PREVIEW MODAL -->
                 <div id="report-view-modal" class="hidden absolute inset-0 bg-slate-900/95 z-50 flex flex-col fade-in">
                     <div class="flex justify-between items-center p-4 border-b border-slate-700 bg-slate-800">
                         <div class="flex items-center gap-2">
                             <i class="fas fa-file-pdf text-red-400 text-xl"></i>
                             <h4 class="text-white font-bold text-sm" id="report-preview-title">Report Preview</h4>
                         </div>
                         <button onclick="document.getElementById('report-view-modal').classList.add('hidden')" class="text-slate-400 hover:text-white"><i class="fas fa-times"></i></button>
                     </div>
                     <div class="flex-grow p-8 overflow-y-auto flex justify-center">
                         <div class="bg-white text-black w-[600px] min-h-[800px] shadow-lg p-10 text-xs">
                             <h1 class="text-xl font-bold mb-4 border-b pb-2">Investment Compliance Report</h1>
                             <div class="grid grid-cols-2 gap-4 mb-6">
                                 <div><strong>Fund:</strong> <span id="prev-fund-name">MORE Tech 100</span></div>
                                 <div><strong>Date:</strong> <span id="prev-date">2024-10-27</span></div>
                             </div>
                             <p class="mb-4">This document certifies compliance with Regulation 12b regarding asset allocation and risk exposure.</p>
                             <div class="bg-gray-100 p-4 rounded mb-4">
                                 <h2 class="font-bold mb-2">1. Asset Summary</h2>
                                 <table class="w-full text-left">
                                     <tr class="border-b"><th class="py-1">Asset Class</th><th class="py-1">Value</th></tr>
                                     <tr><td class="py-1">Equities</td><td class="py-1">$12,000,000</td></tr>
                                     <tr><td class="py-1">Bonds</td><td class="py-1">$4,500,000</td></tr>
                                     <tr><td class="py-1">Cash</td><td class="py-1">$1,200,000</td></tr>
                                 </table>
                             </div>
                             <p class="text-gray-500 italic text-[10px]">Generated by MORE AI System.</p>
                         </div>
                     </div>
                 </div>

                 <!-- REPORT EDITOR MODAL -->
                 <div id="report-edit-modal" class="hidden absolute inset-0 bg-slate-900/95 z-50 flex flex-col fade-in">
                    <!-- Header -->
                    <div class="flex justify-between items-center p-4 border-b border-slate-700 bg-slate-800">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-edit text-blue-400 text-xl"></i>
                            <h4 class="text-white font-bold text-sm" id="report-editor-title">Report Editor</h4>
                        </div>
                        <div class="flex gap-2">
                             <button onclick="closeReportEditor()" class="text-xs text-slate-300 hover:text-white px-3 py-1 rounded border border-slate-600">Cancel</button>
                             <button onclick="saveReportChanges()" class="text-xs bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-500 font-bold">Save Changes</button>
                        </div>
                    </div>
                    <!-- Editor Canvas -->
                    <div class="flex-grow p-8 overflow-y-auto flex justify-center bg-slate-900/50">
                        <div class="bg-white text-black w-[600px] min-h-[800px] shadow-lg p-10 text-xs relative">
                            <!-- Simulated Word/Doc Toolbar -->
                            <div class="absolute top-0 left-0 w-full bg-gray-100 border-b border-gray-300 p-2 flex gap-2">
                                <i class="fas fa-bold text-gray-500 cursor-pointer hover:text-black"></i>
                                <i class="fas fa-italic text-gray-500 cursor-pointer hover:text-black"></i>
                                <i class="fas fa-underline text-gray-500 cursor-pointer hover:text-black"></i>
                                <div class="w-px h-4 bg-gray-300 mx-1"></div>
                                <i class="fas fa-align-left text-gray-500 cursor-pointer hover:text-black"></i>
                                <i class="fas fa-align-center text-gray-500 cursor-pointer hover:text-black"></i>
                            </div>
                            
                            <div class="mt-8"> <!-- Spacer for toolbar -->
                                <h1 class="text-xl font-bold mb-4 border-b pb-2 outline-none hover:bg-blue-50/50 p-1 rounded" contenteditable="true">Investment Compliance Report</h1>
                                
                                <div class="grid grid-cols-2 gap-4 mb-6">
                                    <div><strong>Fund:</strong> <span id="edit-fund-name" class="p-1 hover:bg-blue-100 cursor-text rounded" contenteditable="true">MORE Tech 100</span></div>
                                    <div><strong>Date:</strong> <span id="edit-date" class="p-1 hover:bg-blue-100 cursor-text rounded" contenteditable="true">2024-10-27</span></div>
                                </div>
                                
                                <p class="mb-4 p-1 hover:bg-blue-50/50 rounded" contenteditable="true">This document certifies compliance with Regulation 12b regarding asset allocation and risk exposure.</p>
                                
                                <div class="bg-gray-50 border border-gray-200 p-4 rounded mb-4 relative group">
                                    <div class="absolute -top-2 -right-2 bg-blue-500 text-white text-[9px] px-1 rounded opacity-0 group-hover:opacity-100">Table Block</div>
                                    <h2 class="font-bold mb-2" contenteditable="true">1. Asset Summary</h2>
                                    <table class="w-full text-left">
                                        <tr class="border-b"><th class="py-1">Asset Class</th><th class="py-1">Value</th></tr>
                                        <tr><td class="py-1">Equities</td><td class="py-1"><input type="text" value="$12,000,000" class="border-b border-gray-300 outline-none w-24 bg-transparent focus:border-blue-500 text-blue-700 font-medium"></td></tr>
                                        <tr><td class="py-1">Bonds</td><td class="py-1"><input type="text" value="$4,500,000" class="border-b border-gray-300 outline-none w-24 bg-transparent focus:border-blue-500 text-blue-700 font-medium"></td></tr>
                                        <tr><td class="py-1">Cash</td><td class="py-1"><input type="text" value="$1,200,000" class="border-b border-gray-300 outline-none w-24 bg-transparent focus:border-blue-500 text-blue-700 font-medium"></td></tr>
                                    </table>
                                </div>
                                
                                <div class="border-l-4 border-yellow-400 bg-yellow-50 p-2 mb-4">
                                    <p class="text-[10px] text-gray-600 italic" contenteditable="true">Note: Cash reserves were adjusted due to recent TASE volatility.</p>
                                </div>

                                <p class="text-gray-500 italic text-[10px] mt-8" contenteditable="true">Generated by MORE AI System.</p>
                            </div>
                        </div>
                    </div>
                </div>

                 <!-- GENERATION PROGRESS MODAL -->
                 <div id="gen-modal" class="hidden absolute inset-0 bg-slate-900/90 z-50 flex flex-col items-center justify-center fade-in">
                     <div class="bg-slate-800 border border-purple-500/50 p-8 rounded-2xl shadow-2xl text-center w-80 relative overflow-hidden">
                         <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-purple-500 to-blue-500"></div>
                         <i class="fas fa-circle-notch fa-spin text-4xl text-purple-400 mb-4"></i>
                         <h4 class="text-white font-bold text-lg mb-1" id="gen-modal-title">Generating Report</h4>
                         <p class="text-xs text-slate-400 mb-6">Processing Data Sheet mapping...</p>
                         <div class="w-full bg-slate-700 h-2 rounded-full overflow-hidden mb-2">
                             <div id="gen-progress-bar" class="bg-purple-500 h-full w-0 transition-all ease-out duration-100"></div>
                         </div>
                         <div class="flex justify-between text-[10px] text-slate-500">
                             <span>Reading Excel...</span>
                             <span>Calculations...</span>
                         </div>
                     </div>
                 </div>

                 <div class="app-sidebar">
                     <div class="mb-8 px-2 flex items-center justify-center border-b border-slate-700 pb-6"><img src="logo.png" alt="MORE Investments" class="h-10 w-auto object-contain" onerror="this.style.display='none'"></div>
                     <div class="text-[10px] text-slate-500 uppercase font-bold mb-4 tracking-widest px-2">Navigation</div>
                     <div id="nav-dashboard" class="app-nav-item active" onclick="openUiPage('dashboard')"><i class="fas fa-home w-5"></i> Dashboard</div>
                     <div id="nav-regulations" class="app-nav-item" onclick="openUiPage('regulations')"><i class="fas fa-balance-scale w-5"></i> Regulations</div>
                     <div id="nav-templates" class="app-nav-item" onclick="openUiPage('templates')"><i class="fas fa-layer-group w-5"></i> Templates</div>
                     <div id="nav-datasheet" class="app-nav-item" onclick="openUiPage('datasheet')"><i class="fas fa-table w-5"></i> Data Sheets</div>
                     <div id="nav-reports" class="app-nav-item" onclick="openUiPage('reports')"><i class="fas fa-file-invoice w-5"></i> Reports</div>
                     <div id="nav-audit" class="app-nav-item" onclick="openUiPage('audit')"><i class="fas fa-history w-5"></i> Audit Logs</div>
                 </div>
                 <div class="app-content relative">
                     <!-- PAGE: DASHBOARD -->
                     <div id="ui-page-dashboard" class="fade-in">
                        <div class="flex justify-between items-end mb-6"><div><h3 class="text-2xl font-bold text-white">Welcome back, Admin</h3><p class="text-xs text-slate-400">System Status: <span class="text-green-400">Operational</span></p></div><button class="bg-blue-600 text-white text-xs px-4 py-2 rounded-lg hover:bg-blue-500 transition shadow-lg shadow-blue-500/20" onclick="openUiPage('reports')"><i class="fas fa-plus mr-2"></i> New Report</button></div>
                        
                        <!-- 1. KPI CARDS (Restored to Top) -->
                        <div class="grid grid-cols-3 gap-4 mb-8">
                            <div class="bg-slate-800 p-4 rounded-xl border border-slate-700 hover:border-purple-500 cursor-pointer transition" onclick="openUiPage('templates')"><div class="text-slate-400 text-[10px] uppercase font-bold">Total Templates</div><div class="text-2xl text-white font-bold mt-1">44</div></div>
                            <div class="bg-slate-800 p-4 rounded-xl border border-slate-700 hover:border-blue-500 cursor-pointer transition" onclick="openUiPage('reports-month')"><div class="text-slate-400 text-[10px] uppercase font-bold">Active Reports</div><div class="text-2xl text-white font-bold mt-1" id="kpi-reports-count">12</div></div>
                            <div class="bg-slate-800 p-4 rounded-xl border border-slate-700 hover:border-yellow-500 cursor-pointer transition" onclick="openUiPage('audit-pending')"><div class="text-slate-400 text-[10px] uppercase font-bold">Pending Audit</div><div class="text-2xl text-yellow-400 font-bold mt-1" id="kpi-audit-count">3</div></div>
                        </div>

                        <!-- 2. UPCOMING DEADLINES SECTION -->
                        <div class="bg-gradient-to-r from-red-900/40 to-slate-800 border-l-4 border-red-500 p-4 rounded-xl mb-8">
                            <h4 class="text-white font-bold text-sm mb-3"><i class="fas fa-clock text-red-400 mr-2"></i> Upcoming Submissions (Next 7 Days)</h4>
                            <table class="w-full text-xs text-left">
                                <thead class="text-slate-500 border-b border-slate-700/50">
                                    <tr><th class="pb-2">ETF / Report Name</th><th class="pb-2">Frequency</th><th class="pb-2">Last Submitted</th><th class="pb-2">Next Due</th><th class="pb-2">Action</th></tr>
                                </thead>
                                <tbody class="text-slate-300">
                                    <tr class="border-b border-slate-700/30">
                                        <td class="py-2 font-semibold">MORE Tech 100 ETF</td>
                                        <td class="py-2"><span class="bg-blue-900/50 text-blue-300 px-1.5 py-0.5 rounded text-[10px]">Weekly</span></td>
                                        <td class="py-2">Oct 20</td>
                                        <td class="py-2 text-red-300 font-bold">Oct 27 (Tomorrow)</td>
                                        <td class="py-2"><button onclick="startQuickGenerate('MORE Tech 100 ETF - Oct 27', 'Generated')" class="bg-green-600/20 text-green-400 border border-green-600/50 px-2 py-1 rounded hover:bg-green-600 hover:text-white transition cursor-pointer">Generate</button></td>
                                    </tr>
                                    <tr>
                                        <td class="py-2 font-semibold">Real Estate Bond Fund</td>
                                        <td class="py-2"><span class="bg-purple-900/50 text-purple-300 px-1.5 py-0.5 rounded text-[10px]">Monthly</span></td>
                                        <td class="py-2">Sep 30</td>
                                        <td class="py-2 text-yellow-300">Oct 31</td>
                                        <td class="py-2"><button onclick="startQuickGenerate('Real Estate Bond Fund - Oct 31', 'Generated')" class="bg-green-600/20 text-green-400 border border-green-600/50 px-2 py-1 rounded hover:bg-green-600 hover:text-white transition cursor-pointer">Generate</button></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- 3. VISUALS ROW (Restored) -->
                        <div class="grid grid-cols-2 gap-6 mb-8">
                            <div class="bg-slate-800/50 p-6 rounded-xl border border-slate-700 flex flex-col items-center justify-center">
                                <h4 class="text-xs text-slate-400 mb-4 uppercase font-bold">Reports by Type</h4>
                                <div class="pie-chart mb-4"></div>
                                <div class="flex gap-4 text-[9px] text-slate-400">
                                    <span class="flex items-center gap-1"><div class="w-2 h-2 bg-blue-500 rounded-full"></div> ETF</span>
                                    <span class="flex items-center gap-1"><div class="w-2 h-2 bg-green-500 rounded-full"></div> Mutual</span>
                                    <span class="flex items-center gap-1"><div class="w-2 h-2 bg-yellow-500 rounded-full"></div> Bond</span>
                                </div>
                            </div>
                            <div class="bg-slate-800/50 p-6 rounded-xl border border-slate-700 flex flex-col items-center justify-center">
                                <h4 class="text-xs text-slate-400 mb-4 uppercase font-bold">Submission Volume (Weekly)</h4>
                                <div class="flex items-end h-20 gap-2">
                                    <div class="chart-bar" style="height: 30%;"></div>
                                    <div class="chart-bar" style="height: 50%;"></div>
                                    <div class="chart-bar" style="height: 80%;"></div>
                                    <div class="chart-bar" style="height: 60%;"></div>
                                    <div class="chart-bar" style="height: 90%;"></div>
                                    <div class="chart-bar" style="height: 40%;"></div>
                                    <div class="chart-bar" style="height: 70%;"></div>
                                </div>
                            </div>
                        </div>

                        <!-- 4. ACTIVITY & HEALTH ROW (Restored) -->
                        <div class="grid grid-cols-3 gap-6">
                            <div class="col-span-2 bg-slate-800/50 p-4 rounded-xl border border-slate-700">
                                <h4 class="text-xs text-slate-300 font-bold uppercase mb-3">Recent Activity</h4>
                                <div class="space-y-3">
                                    <div class="flex items-start gap-3"><div class="w-2 h-2 bg-blue-500 rounded-full mt-1.5"></div><div><p class="text-xs text-slate-300"><strong>Analyst A</strong> submitted <em>Oct 2024 ETF Report</em>.</p><p class="text-[10px] text-slate-500">2 hours ago</p></div></div>
                                    <div class="flex items-start gap-3"><div class="w-2 h-2 bg-purple-500 rounded-full mt-1.5"></div><div><p class="text-xs text-slate-300"><strong>Admin</strong> updated <em>Reg 12b</em> to version 1.2.</p><p class="text-[10px] text-slate-500">5 hours ago</p></div></div>
                                    <div class="flex items-start gap-3"><div class="w-2 h-2 bg-green-500 rounded-full mt-1.5"></div><div><p class="text-xs text-slate-300"><strong>Analyst B</strong> created new template <em>Bond Yield Summary</em>.</p><p class="text-[10px] text-slate-500">Yesterday</p></div></div>
                                </div>
                            </div>
                            <div class="bg-slate-800/50 p-4 rounded-xl border border-slate-700">
                                <h4 class="text-xs text-slate-300 font-bold uppercase mb-3">System Health</h4>
                                <div class="space-y-2">
                                    <div class="flex justify-between text-xs text-slate-400"><span>API Status</span><span class="text-green-400 font-bold">Online</span></div>
                                    <div class="w-full bg-slate-700 h-1 rounded-full"><div class="bg-green-500 h-1 rounded-full w-full"></div></div>
                                    <div class="flex justify-between text-xs text-slate-400 mt-2"><span>Database Load</span><span class="text-blue-400 font-bold">12%</span></div>
                                    <div class="w-full bg-slate-700 h-1 rounded-full"><div class="bg-blue-500 h-1 rounded-full w-[12%]"></div></div>
                                    <div class="flex justify-between text-xs text-slate-400 mt-2"><span>AI Token Usage</span><span class="text-yellow-400 font-bold">65%</span></div>
                                    <div class="w-full bg-slate-700 h-1 rounded-full"><div class="bg-yellow-500 h-1 rounded-full w-[65%]"></div></div>
                                </div>
                            </div>
                        </div>
                     </div>
                     
                     <!-- PAGE: TEMPLATES -->
                     <div id="ui-page-templates" class="hidden">
                        <div id="template-step-list"><div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-white">Template Library</h3><button onclick="startTemplateWizard()" class="bg-purple-600 text-white text-xs px-4 py-2 rounded-lg hover:bg-purple-500 transition shadow-lg shadow-purple-500/20"><i class="fas fa-magic mr-2"></i> + New Template (Reverse Engineer)</button></div><div class="bg-slate-800 rounded-xl overflow-hidden mb-8 border border-slate-700"><table class="mock-table"><thead><tr class="bg-slate-700/50"><th>Name</th><th>Data Source</th><th>Processed</th><th>Status</th><th>Actions</th></tr></thead><tbody><tr><td class="font-bold text-white">ETF Monthly V1</td><td>ETF_Data_Master.xlsx</td><td><span class="text-green-400">100%</span></td><td><span class="text-green-400"> Active</span></td><td><span class="mock-btn-sm btn-blue">Edit</span><span class="mock-btn-sm btn-purple" onclick="toggleTemplateHistory()">History</span><span class="mock-btn-sm btn-green" onclick="showToast('Viewing Template...')">View</span><span class="mock-btn-sm btn-green" onclick="startReportWizard()">Use</span></td></tr><tr id="draft-template-row"><td class="font-bold text-white">TASE Weekly Summary</td><td>TASE_Raw_Export.xlsx</td><td><span class="text-yellow-400">85%</span></td><td id="draft-status"><span class="text-yellow-400"> Draft</span></td><td id="draft-actions"><span class="mock-btn-sm btn-blue">Edit</span><span class="mock-btn-sm btn-purple" onclick="toggleTemplateHistory()">History</span><span class="mock-btn-sm btn-green" onclick="showToast('Viewing Template...')">View</span><span class="mock-btn-sm btn-green bg-green-900/50 border-green-800 text-green-200" onclick="activateTemplate(this)">Activate</span></td></tr></tbody></table></div><div class="border border-purple-500/30 bg-purple-900/10 rounded-2xl p-6"><h4 class="text-purple-400 font-bold text-xs uppercase mb-4 tracking-widest text-center">Flow: Creating a New Template</h4><div class="flex items-start gap-0 overflow-x-auto pb-4 justify-center"><div class="flow-card"><div class="flow-card-title">1. Upload</div><div class="mock-window-sm h-12 w-20"><div class="mock-header-sm"></div><div class="text-[6px] text-slate-500 flex justify-center items-center h-full">Prev Report + Sheet</div></div></div><div class="flow-arrow-container pt-6"><div class="flow-action-label">System Reads</div><div class="flow-line"><div class="flow-packet purple"></div></div></div><div class="flow-card border-dashed border-purple-500/50 bg-purple-900/20"><div class="flow-card-title">2. AI Logic</div><i class="fas fa-cogs fa-spin text-purple-400 text-lg"></i><span class="text-[8px] text-purple-300 mt-1">Maps Fields to Cells</span></div><div class="flow-arrow-container pt-6"><div class="flow-action-label">Review Map</div><div class="flow-line"><div class="flow-packet purple" style="animation-delay: 0.5s"></div></div></div><div class="flow-card"><div class="flow-card-title">3. Save</div><i class="fas fa-save text-green-400 text-lg"></i><span class="text-[8px] text-slate-400 mt-1">Available in Library</span></div></div></div></div>
                        <div id="template-step-wizard" class="hidden flex flex-col items-center justify-center h-full pt-10"><div class="bg-slate-800 p-8 rounded-2xl border border-purple-500/50 max-w-lg w-full shadow-2xl relative"><button onclick="cancelTemplateWizard()" class="absolute top-4 right-4 text-slate-500 hover:text-white"><i class="fas fa-times"></i></button><h3 class="text-xl font-bold text-white mb-6 text-center">New Template Wizard</h3><div id="wiz-upload" class="text-center"><div class="grid grid-cols-3 gap-4 mb-6"><div class="border-2 border-dashed border-slate-600 rounded-xl p-4 hover:border-purple-500 transition cursor-pointer"><i class="fas fa-file-contract text-2xl text-slate-500 mb-2"></i><p class="text-[10px] text-slate-400">Previous Report PDF</p></div><div class="border-2 border-dashed border-slate-600 rounded-xl p-4 hover:border-purple-500 transition cursor-pointer"><i class="fas fa-table text-2xl text-slate-500 mb-2"></i><p class="text-[10px] text-slate-400">Data Sheet (Excel)</p></div><div class="border-2 border-dashed border-slate-600 rounded-xl p-4 hover:border-purple-500 transition cursor-pointer"><i class="fas fa-file-pdf text-2xl text-slate-500 mb-2"></i><p class="text-[10px] text-slate-400">Regulation PDF</p></div></div><button onclick="runAiAnalysis()" class="bg-purple-600 text-white px-6 py-2 rounded-lg text-sm w-full">Start Reverse Engineering</button></div><div id="wiz-processing" class="hidden text-center py-6"><i class="fas fa-circle-notch fa-spin text-4xl text-purple-400 mb-4"></i><h4 class="text-white font-bold">AI Processing...</h4><div class="w-full bg-slate-700 h-2 rounded-full mt-4 mb-2 overflow-hidden"><div id="ai-progress-bar" class="bg-purple-500 h-full w-0 transition-all duration-[2000ms] ease-out"></div></div><p class="text-xs text-slate-400">Mapping PDF Values to Excel Cells...</p></div><div id="wiz-success" class="hidden text-center"><div class="w-16 h-16 bg-green-500/20 rounded-full flex items-center justify-center mx-auto mb-4"><i class="fas fa-check text-green-400 text-3xl"></i></div><h4 class="text-white font-bold text-lg">Analysis Complete</h4><p class="text-xs text-slate-400 mt-1 mb-2">Successfully mapped <strong>45 fields</strong>.</p><div class="bg-slate-900 p-3 rounded mb-6 border border-green-500/30"><div class="flex justify-between text-xs mb-1"><span class="text-slate-400">Mapping Confidence:</span><span class="text-green-400 font-bold">85%</span></div><div class="w-full bg-slate-700 h-1.5 rounded-full"><div class="bg-green-500 h-1.5 rounded-full w-[85%]"></div></div></div><button onclick="finishTemplateWizard()" class="bg-green-600 text-white px-6 py-2 rounded-lg text-sm w-full">Save Template to Library</button></div></div></div>
                        <div id="template-history-modal" class="hidden absolute top-0 left-0 w-full h-full bg-black/80 flex items-center justify-center z-50"><div class="bg-slate-800 p-6 rounded-xl border border-slate-600 w-96 relative shadow-2xl"><button onclick="toggleTemplateHistory()" class="absolute top-3 right-3 text-slate-400 hover:text-white"><i class="fas fa-times"></i></button><h4 class="text-white font-bold mb-4">Change Log: TASE Weekly</h4><div class="space-y-3 text-xs text-slate-300"><div class="flex justify-between border-b border-slate-700 pb-2"><span><span class="text-green-400">Created</span> by Admin</span><span class="text-slate-500">2024-10-24 09:30</span></div><div class="flex justify-between border-b border-slate-700 pb-2"><span><span class="text-blue-400">Mapping Edit</span> by User B</span><span class="text-slate-500">2024-10-24 11:15</span></div><div class="flex justify-between border-b border-slate-700 pb-2"><span><span class="text-purple-400">Formula Update</span> by Admin</span><span class="text-slate-500">2024-10-25 14:00</span></div></div></div></div>
                     </div>

                     <!-- PAGE: REPORTS (UPDATED) -->
                     <div id="ui-page-reports" class="hidden">
                        <div id="report-step-list">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-white">Generated Reports</h3>
                                <div class="flex gap-2">
                                    <input type="text" placeholder="Search..." class="bg-slate-800 border border-slate-600 rounded px-3 py-1 text-xs text-white w-40">
                                    <button onclick="startReportWizard()" class="bg-green-600 text-white text-xs px-4 py-2 rounded-lg hover:bg-green-500 transition shadow-lg shadow-green-500/20"><i class="fas fa-plus mr-2"></i> Generate New</button>
                                </div>
                            </div>
                            <div class="bg-slate-800 rounded-xl overflow-hidden mb-8 border border-slate-700">
                                <table class="mock-table" id="reports-table">
                                    <thead>
                                        <tr class="bg-slate-700/50">
                                            <th>Report / ETF</th>
                                            <th>Freq</th>
                                            <th>Last Submitted</th>
                                            <th>Next Due</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="reports-table-body">
                                        <!-- Rows added dynamically here -->
                                        <tr>
                                            <td class="font-bold text-white">MORE Tech 100 ETF</td>
                                            <td><span class="text-slate-400">Weekly</span></td>
                                            <td>Oct 20</td>
                                            <td class="text-red-400 font-bold">Oct 27</td>
                                            <td><span class="text-yellow-400 text-[9px] border border-yellow-500 px-1 rounded bg-yellow-900/20">Draft</span></td>
                                            <td><span class="mock-btn-sm btn-purple" onclick="runGeneration(this)">Generate</span><span class="mock-btn-sm btn-blue" onclick="editReportData('MORE Tech 100 ETF')">Edit</span><span class="mock-btn-sm btn-red" onclick="requestAction('delete', this)">Delete</span></td>
                                        </tr>
                                        <tr>
                                            <td class="font-bold text-white">TASE Weekly Update</td>
                                            <td><span class="text-slate-400">Weekly</span></td>
                                            <td>Oct 20</td>
                                            <td class="text-green-400">Today</td>
                                            <td><span class="text-blue-400 text-[9px] border border-blue-500 px-1 rounded bg-blue-900/20">Generated</span></td>
                                            <td><span class="mock-btn-sm btn-green" onclick="requestAction('submit', this)">Submit</span><span class="mock-btn-sm btn-green" onclick="viewReport('TASE Weekly Update')">View</span><span class="mock-btn-sm btn-blue" onclick="editReportData('TASE Weekly Update')">Edit</span></td>
                                        </tr>
                                        <tr>
                                            <td class="font-bold text-white">Real Estate Bond Fund</td>
                                            <td><span class="text-slate-400">Monthly</span></td>
                                            <td>Sep 30</td>
                                            <td class="text-yellow-400">Oct 31</td>
                                            <td><span class="text-green-400 text-[9px] border border-green-500 px-1 rounded">Submitted</span></td>
                                            <td><span class="mock-btn-sm btn-green" onclick="viewReport('Real Estate Bond Fund')">View</span></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="border border-green-500/30 bg-green-900/10 rounded-2xl p-6">
                                <h4 class="text-green-400 font-bold text-xs uppercase mb-4 tracking-widest text-center">Flow: Generating a Report</h4>
                                <div class="flex items-start gap-0 overflow-x-auto pb-4 justify-center">
                                    <div class="flow-card"><div class="flow-card-title">1. Select</div><div class="text-[8px] text-slate-400">Pick "ETF Template"</div></div>
                                    <div class="flow-arrow-container pt-6"><div class="flow-action-label">Load Data Sheet</div><div class="flow-line"><div class="flow-packet green"></div></div></div>
                                    <div class="flow-card w-40 border-yellow-500/50"><div class="flow-card-title text-yellow-400">2. Data Editor</div><div class="mock-window-sm h-10 w-full border-yellow-500/30 bg-slate-900"><div class="mock-header-sm bg-yellow-900/40"></div><div class="grid grid-cols-3 gap-0.5 p-0.5"><div class="bg-slate-700 h-2"></div><div class="bg-yellow-500/20 h-2"></div><div class="bg-slate-700 h-2"></div></div></div><span class="text-[8px] text-slate-400 mt-1">Manual updates only</span></div>
                                    <div class="flow-arrow-container pt-6"><div class="flow-action-label">Run & Calc</div><div class="flow-line"><div class="flow-packet green" style="animation-delay: 0.5s"></div></div></div>
                                    <div class="flow-card"><div class="flow-card-title">3. Audit</div><i class="fas fa-search-dollar text-green-400 text-lg"></i><span class="text-[8px] text-slate-400 mt-1">Verify Output</span></div>
                                </div>
                            </div>
                        </div>
                        <div id="report-step-wizard" class="hidden flex flex-col items-center justify-center h-full pt-4"><div class="bg-slate-800 p-6 rounded-2xl border border-green-500/50 max-w-2xl w-full shadow-2xl relative"><button onclick="cancelReportWizard()" class="absolute top-4 right-4 text-slate-500 hover:text-white"><i class="fas fa-times"></i></button><div class="grid grid-cols-2 gap-6 h-full"><div class="border-r border-slate-700 pr-4"><h3 class="text-lg font-bold text-white mb-4">New Report</h3><div class="space-y-4"><div class="text-xs text-green-400 font-bold">1. Select Template</div><div class="text-xs text-slate-500">2. Data Editor</div><div class="text-xs text-slate-500">3. Review & Audit</div></div></div><div><label class="text-xs text-slate-400 block mb-2">Choose Template:</label><select class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-xs text-white mb-4"><option>ETF Monthly V1</option><option>TASE Weekly</option></select><label class="text-xs text-slate-400 block mb-2">Select Data Source:</label><select class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-xs text-white mb-6"><option>ETF_Data_Master.xlsx (Latest)</option><option>ETF_Data_Master_v2.xlsx</option></select>
                        <div class="bg-slate-900 p-3 rounded mb-6 border border-yellow-500/30 flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-yellow-900/30 border border-yellow-500/50 flex items-center justify-center text-yellow-400"><i class="fas fa-magic"></i></div>
                            <div>
                                <div class="text-[10px] text-yellow-400 font-bold uppercase">Manual Creation</div>
                                <div class="text-[9px] text-slate-400">Uses Template + Sheet logic</div>
                            </div>
                        </div>
                        <button onclick="finishReportWizard()" class="bg-yellow-600 text-white w-full py-2 rounded text-xs font-bold hover:bg-yellow-500">Generate First Draft</button></div></div></div></div>
                     </div>

                     <!-- PAGE: AUDIT LOGS -->
                     <div id="ui-page-audit" class="hidden">
                        <h3 class="text-xl font-bold text-white mb-6">Audit History</h3>
                        <div class="bg-slate-900 p-4 rounded-xl border border-slate-700 font-mono text-xs text-slate-400 h-64 overflow-y-auto"><div class="mb-2"><span class="text-slate-500">[10:05 AM]</span> User <strong>Analyst_A</strong> updated "Cash Flow" in <em>Oct Report</em> from <span class="text-red-400">1.2M</span> to <span class="text-green-400">1.5M</span>.</div><div class="mb-2"><span class="text-slate-500">[09:30 AM]</span> User <strong>Admin</strong> created new template "Bond Summary V2".</div><div class="mb-2"><span class="text-slate-500">[Yesterday]</span> System generated "Q3 Summary" (Success).</div></div>
                     </div>
                     
                     <!-- PAGE: REGULATIONS -->
                     <div id="ui-page-regulations" class="hidden">
                        <div id="reg-list-view"><div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-white">Regulatory Documents</h3><div class="flex gap-2"><input type="text" placeholder="Search Docs..." class="bg-slate-800 border border-slate-600 rounded px-3 py-1 text-xs text-white w-40"><button onclick="startRegUpload()" class="bg-blue-600 text-white text-xs px-4 py-2 rounded-lg hover:bg-blue-500 transition shadow-lg shadow-blue-500/20"><i class="fas fa-upload mr-2"></i> Upload New</button></div></div><div class="bg-slate-800 rounded-xl overflow-hidden border border-slate-700"><table class="mock-table"><thead><tr class="bg-slate-700/50"><th>Document Name</th><th>Current Version</th><th>Effective Date</th><th>Status</th><th>Actions</th></tr></thead><tbody><tr><td class="font-bold text-white"><i class="fas fa-file-pdf text-red-500 mr-2"></i> Capital Adequacy 12b</td><td>v1.0</td><td>2024-01-01</td><td><span class="text-green-400"> Active</span></td><td><span class="mock-btn-sm btn-blue" onclick="showToast('Viewing PDF...')">View</span><span class="mock-btn-sm btn-purple" onclick="openRegHistory('Capital Adequacy 12b')">History</span><span class="mock-btn-sm btn-purple" style="background: rgba(139,92,246,0.2); border-color: rgba(139,92,246,0.4); color: #c4b5fd;" onclick="startRegUpload()">Replace</span></td></tr><tr id="reg-row-tase"><td class="font-bold text-white"><i class="fas fa-file-pdf text-red-500 mr-2"></i> TASE Listing Rules</td><td>v2.4</td><td>2023-11-15</td><td><span class="text-green-400" id="reg-status-tase"> Active</span></td><td id="reg-actions-tase"><span class="mock-btn-sm btn-blue" onclick="showToast('Viewing PDF...')">View</span><span class="mock-btn-sm btn-purple" onclick="openRegHistory('TASE Listing Rules')">History</span><span class="mock-btn-sm btn-purple" style="background: rgba(139,92,246,0.2); border-color: rgba(139,92,246,0.4); color: #c4b5fd;" onclick="startRegUpload()">Replace</span></td></tr></tbody></table></div><div class="border border-purple-500/30 bg-purple-900/10 rounded-2xl p-6 mt-8"><h4 class="text-purple-400 font-bold text-xs uppercase mb-4 tracking-widest text-center">Flow: Regulation Update Cycle</h4><div class="flex items-start gap-0 overflow-x-auto pb-4 justify-center"><div class="flow-card"><div class="flow-card-title">1. ISA</div><i class="fas fa-university text-slate-400 text-2xl my-2"></i><span class="text-[8px] text-slate-500">Issues New Reg</span></div><div class="flow-arrow-container pt-6"><div class="flow-action-label">Publishes</div><div class="flow-line"><div class="flow-packet purple"></div></div></div><div class="flow-card"><div class="flow-card-title">2. Ingest</div><i class="fas fa-cloud-upload-alt text-purple-400 text-2xl my-2"></i><span class="text-[8px] text-slate-400">PDF Upload</span></div><div class="flow-arrow-container pt-6"><div class="flow-action-label">AI Processing</div><div class="flow-line"><div class="flow-packet purple" style="animation-delay: 0.5s"></div></div></div><div class="flow-card border-dashed border-purple-500/50 bg-purple-900/20"><div class="flow-card-title">3. Diff Engine</div><div class="relative w-8 h-8 mx-auto my-2"><i class="fas fa-arrow-right absolute top-0 left-0 text-green-400 anim-diff-r"></i><i class="fas fa-arrow-left absolute bottom-0 right-0 text-red-400 anim-diff-l"></i></div><span class="text-[8px] text-purple-200">Detects Changes</span></div><div class="flow-arrow-container pt-6"><div class="flow-action-label">Alerts Admin</div><div class="flow-line"><div class="flow-packet purple" style="animation-delay: 1s"></div></div></div><div class="flow-card"><div class="flow-card-title">4. Impact</div><i class="fas fa-exclamation-triangle text-yellow-400 text-2xl my-2"></i><span class="text-[8px] text-slate-400">Flags Affected Templates</span></div></div></div></div>
                        <div id="reg-upload-wizard" class="hidden flex flex-col items-center justify-center h-full pt-10 absolute top-0 left-0 w-full bg-slate-900/95 z-50"><div class="bg-slate-800 p-8 rounded-2xl border border-purple-500/50 max-w-lg w-full shadow-2xl relative"><button onclick="cancelRegUpload()" class="absolute top-4 right-4 text-slate-500 hover:text-white"><i class="fas fa-times"></i></button><h3 class="text-xl font-bold text-white mb-6 text-center">Replacing: TASE Listing Rules (v2.4)</h3><div id="reg-wiz-upload" class="text-center"><div class="border-2 border-dashed border-slate-600 rounded-xl p-8 mb-6 hover:border-purple-500 transition cursor-pointer"><i class="fas fa-file-pdf text-4xl text-slate-500 mb-2"></i><p class="text-xs text-slate-400">Drag & Drop <strong>New Regulation PDF</strong> here</p></div><button onclick="runRegProcessing()" class="bg-purple-600 text-white px-6 py-2 rounded-lg text-sm w-full">Start Processing</button></div><div id="reg-wiz-processing" class="hidden text-center py-6"><i class="fas fa-microchip fa-spin text-4xl text-purple-400 mb-4"></i><h4 class="text-white font-bold">AI Analyzing Changes...</h4><div class="w-full bg-slate-700 h-2 rounded-full mt-4 mb-2 overflow-hidden"><div id="reg-progress-bar" class="bg-purple-500 h-full w-0 transition-all duration-[2000ms] ease-out"></div></div><p class="text-xs text-slate-400">Comparing against previous version...</p></div><div id="reg-wiz-success" class="hidden text-center"><div class="w-16 h-16 bg-green-500/20 rounded-full flex items-center justify-center mx-auto mb-4"><i class="fas fa-check text-green-400 text-3xl"></i></div><h4 class="text-white font-bold text-lg">Analysis Complete</h4><p class="text-xs text-slate-400 mt-1 mb-6">Detected <strong>2 modifications</strong> in formulas.</p><button onclick="finishRegUpload()" class="bg-green-600 text-white px-6 py-2 rounded-lg text-sm w-full">View Diff & Confirm</button></div></div></div>
                        <div id="reg-history-view" class="hidden h-full flex flex-col"><div class="flex justify-between items-center mb-6"><div class="flex items-center gap-3"><button onclick="closeRegHistory()" class="text-xs text-slate-400 hover:text-white"><i class="fas fa-arrow-left mr-1"></i> Back to History</button><div><h3 class="text-xl font-bold text-white" id="reg-history-title">Capital Adequacy 12b</h3><p class="text-xs text-slate-400">Version History & Management</p></div></div><button onclick="startRegUpload()" class="bg-blue-600 text-white text-xs px-4 py-2 rounded-lg hover:bg-blue-500 transition shadow-lg shadow-blue-500/20"><i class="fas fa-cloud-upload-alt mr-2"></i> Upload New Version</button></div><div class="bg-slate-800 rounded-xl overflow-hidden border border-slate-700 mb-6"><table class="mock-table"><thead><tr class="bg-slate-700/50"><th class="w-10 text-center"><input type="checkbox"></th><th>Version</th><th>Uploaded Date</th><th>By</th><th>Status</th><th>Actions</th></tr></thead><tbody><tr class="bg-slate-700/30"><td class="text-center"><input type="checkbox" checked disabled></td><td class="font-bold text-white">v1.2</td><td>2024-02-15</td><td>Admin</td><td><span class="text-green-400 border border-green-500/50 px-1 rounded text-[9px]">Active</span></td><td><span class="mock-btn-sm btn-blue">View</span></td></tr><tr><td class="text-center"><input type="checkbox"></td><td class="font-bold text-slate-400">v1.1</td><td>2024-01-20</td><td>User B</td><td><span class="text-slate-500 text-[9px]">Archived</span></td><td><span class="mock-btn-sm btn-blue">View</span><span class="mock-btn-sm btn-green" onclick="showToast('Version Activated')">Activate</span></td></tr><tr><td class="text-center"><input type="checkbox"></td><td class="font-bold text-slate-400">v1.0</td><td>2024-01-01</td><td>Admin</td><td><span class="text-slate-500 text-[9px]">Archived</span></td><td><span class="mock-btn-sm btn-blue">View</span><span class="mock-btn-sm btn-green" onclick="showToast('Version Activated')">Activate</span></td></tr></tbody></table></div><div class="bg-slate-900 border border-slate-700 p-4 rounded-xl flex justify-between items-center"><div class="text-xs text-slate-400"><i class="fas fa-info-circle mr-2 text-blue-400"></i> Select exactly two versions to compare changes.</div><button onclick="openRegDiff()" class="bg-purple-600 text-white text-xs px-6 py-2 rounded-lg hover:bg-purple-500 transition border border-purple-400">Compare Selected (2)</button></div></div>
                        <div id="reg-diff-view" class="hidden h-full flex flex-col">
                            <div class="flex justify-between items-center mb-4">
                                <div class="flex items-center gap-3">
                                    <button onclick="closeRegDiff()" class="text-xs text-slate-400 hover:text-white"><i class="fas fa-arrow-left mr-1"></i> Back to List (Pending)</button>
                                    <h3 class="text-lg font-bold text-white">Regulator Change Detection</h3>
                                </div>
                                <div class="text-xs text-slate-400">Comparing: <strong>v2.4</strong> vs <strong>v2.5 (New)</strong></div>
                            </div>
                            <div class="flex-grow flex gap-4 overflow-hidden">
                                <!-- Old Version -->
                                <div class="w-1/2 bg-slate-900 rounded-lg border border-slate-700 p-4 overflow-y-auto">
                                    <div class="text-[10px] text-slate-500 uppercase font-bold mb-2 border-b border-slate-700 pb-1">Current Version (v2.4)</div>
                                    <p class="text-xs text-slate-400 leading-relaxed">
                                        4.1. Risk Weight Calculation.<br>
                                        The risk weight for asset class A shall be calculated as <span class="bg-red-900/50 text-red-300 px-1 rounded">12%</span> of the total exposure. This applies to all ETF instruments...
                                    </p>
                                </div>
                                <!-- New Version -->
                                <div class="w-1/2 bg-slate-900 rounded-lg border border-slate-700 p-4 overflow-y-auto">
                                    <div class="text-[10px] text-slate-500 uppercase font-bold mb-2 border-b border-slate-700 pb-1">New Upload (v2.5)</div>
                                    <p class="text-xs text-slate-400 leading-relaxed">
                                        4.1. Risk Weight Calculation.<br>
                                        The risk weight for asset class A shall be calculated as <span class="bg-green-900/50 text-green-300 px-1 rounded">15%</span> of the total exposure. This applies to all ETF instruments...
                                    </p>
                                </div>
                            </div>
                            
                            <div class="mt-4 bg-yellow-900/20 border border-yellow-600/50 p-3 rounded flex flex-col justify-between items-start gap-2">
                                <div class="text-xs text-yellow-200"><i class="fas fa-exclamation-triangle mr-2"></i><strong>Impact Analysis:</strong> This change affects <strong>3 Templates</strong> (Click to Review):</div>
                                <div class="flex gap-2 mt-1">
                                    <button onclick="openTemplateImpact('ETF Monthly V1')" class="text-[10px] bg-slate-800 hover:bg-slate-700 border border-slate-600 text-blue-300 px-2 py-1 rounded transition">ETF Monthly V1</button>
                                    <button onclick="openTemplateImpact('Risk Report Q3')" class="text-[10px] bg-slate-800 hover:bg-slate-700 border border-slate-600 text-blue-300 px-2 py-1 rounded transition">Risk Report Q3</button>
                                    <button onclick="openTemplateImpact('Bond Yield Summary')" class="text-[10px] bg-slate-800 hover:bg-slate-700 border border-slate-600 text-blue-300 px-2 py-1 rounded transition">Bond Yield Summary</button>
                                </div>
                            </div>
                        </div>

                        <!-- Template Impact Modal (NEW) -->
                        <div id="template-impact-modal" class="hidden absolute top-0 left-0 w-full h-full bg-slate-900/95 z-50 flex items-center justify-center p-8">
                            <div class="bg-slate-800 border border-slate-600 rounded-xl w-full max-w-4xl h-full max-h-[600px] flex flex-col shadow-2xl relative">
                                <!-- Header -->
                                <div class="flex justify-between items-center p-4 border-b border-slate-700">
                                    <div>
                                        <h3 class="text-lg font-bold text-white" id="impact-template-title">ETF Monthly V1</h3>
                                        <p class="text-xs text-slate-400">Reviewing impact of Regulation Change (v2.5)</p>
                                    </div>
                                    <button onclick="closeTemplateImpact()" class="text-slate-400 hover:text-white"><i class="fas fa-times"></i></button>
                                </div>
                                
                                <!-- Content -->
                                <div class="flex-grow p-4 overflow-auto">
                                    <!-- Simulated Excel Grid -->
                                     <table class="ds-table w-full">
                                        <thead>
                                            <tr><th>Cell</th><th>Formula</th><th>Previous Value</th><th>New Value</th><th>Status</th></tr>
                                        </thead>
                                        <tbody>
                                            <tr><td>C12</td><td>= (Assets * RiskWeight)</td><td>12%</td><td class="bg-green-900/30 text-green-400 border border-green-500">15%</td><td><span class="text-yellow-400">Pending Review</span></td></tr>
                                            <tr><td>D14</td><td>= SUM(C10:C13)</td><td>1,200,000</td><td class="bg-green-900/30 text-green-400 border border-green-500">1,500,000</td><td><span class="text-yellow-400">Pending Review</span></td></tr>
                                        </tbody>
                                     </table>
                                     
                                     <div class="mt-6 bg-slate-900 p-4 rounded border border-purple-500/30">
                                         <h4 class="text-sm font-bold text-purple-300 mb-2">AI Reasoning</h4>
                                         <p class="text-xs text-slate-400">Regulation <strong>Section 4.1</strong> changed the base risk weight modifier. This template uses that variable in cell <strong>C12</strong>. Recalculation is required.</p>
                                     </div>
                                </div>

                                <!-- Footer Actions -->
                                <div class="p-4 border-t border-slate-700 flex justify-end gap-3">
                                    <button onclick="closeTemplateImpact()" class="bg-transparent border border-slate-500 text-slate-300 px-4 py-2 rounded text-xs">Cancel</button>
                                    <button onclick="showToast('Change Rejected.'); closeTemplateImpact();" class="bg-red-900/50 border border-red-500 text-red-300 px-4 py-2 rounded text-xs hover:bg-red-900">Reject Change</button>
                                    <button onclick="showToast('Change Approved!'); closeTemplateImpact();" class="bg-green-600 text-white px-6 py-2 rounded text-xs font-bold hover:bg-green-500">Approve & Update</button>
                                </div>
                            </div>
                        </div>

                     </div>

                     <!-- PAGE: DATA SHEET -->
                     <div id="ui-page-datasheet" class="hidden">
                        <div id="ds-view-list"><div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-white">Available Data Sheets</h3><div class="flex gap-2"><input type="text" placeholder="Search..." class="bg-slate-800 border border-slate-600 rounded px-3 py-1 text-xs text-white w-40"><button class="bg-blue-600 text-white text-xs px-4 py-2 rounded-lg hover:bg-blue-500 transition shadow-lg shadow-blue-500/20"><i class="fas fa-upload mr-2"></i> Upload New</button></div></div><div class="bg-slate-800 rounded-xl overflow-hidden border border-slate-700"><table class="mock-table"><thead><tr class="bg-slate-700/50"><th>File Name</th><th>Linked Template</th><th>Last Updated</th><th>Updated By</th><th>Actions</th></tr></thead><tbody><tr><td class="font-bold text-white"><i class="fas fa-file-excel text-green-500 mr-2"></i> ETF_Data_Master.xlsx</td><td>ETF Monthly V1</td><td>2024-10-25</td><td>Analyst A</td><td><span class="mock-btn-sm btn-blue" onclick="openDataSheet('ETF_Data_Master.xlsx')">View Data</span></td></tr><tr><td class="font-bold text-white"><i class="fas fa-file-excel text-green-500 mr-2"></i> Bond_Yields_Q3.xlsx</td><td>Bond Summary V2</td><td>2024-10-20</td><td>Admin</td><td><span class="mock-btn-sm btn-blue" onclick="openDataSheet('Bond_Yields_Q3.xlsx')">View Data</span></td></tr><tr><td class="font-bold text-white"><i class="fas fa-file-excel text-green-500 mr-2"></i> TASE_Raw_Export.xlsx</td><td>TASE Weekly</td><td>2024-10-18</td><td>Analyst B</td><td><span class="mock-btn-sm btn-blue" onclick="openDataSheet('TASE_Raw_Export.xlsx')">View Data</span></td></tr></tbody></table></div><div class="border border-green-500/30 bg-green-900/10 rounded-2xl p-6 mt-8"><h4 class="text-green-400 font-bold text-xs uppercase mb-4 tracking-widest text-center">Flow: Data Integration</h4><div class="flex items-start gap-0 overflow-x-auto pb-4 justify-center"><div class="flow-card"><div class="flow-card-title">1. Source</div><i class="fas fa-file-csv text-slate-400 text-2xl my-2"></i><span class="text-[8px] text-slate-500">Excel / Bloomberg</span></div><div class="flow-arrow-container pt-6"><div class="flow-action-label">Ingest</div><div class="flow-line"><div class="flow-packet green"></div></div></div><div class="flow-card"><div class="flow-card-title">2. Validate</div><i class="fas fa-shield-alt text-green-400 text-2xl my-2"></i><span class="text-[8px] text-slate-400">Type Check</span></div><div class="flow-arrow-container pt-6"><div class="flow-action-label">Apply Rules</div><div class="flow-line"><div class="flow-packet green" style="animation-delay: 0.5s"></div></div></div><div class="flow-card border-dashed border-green-500/50 bg-green-900/20"><div class="flow-card-title">3. Calc Engine</div><i class="fas fa-cog fa-spin text-green-300 text-2xl my-2"></i><span class="text-[8px] text-green-200">Reg Formulas</span></div><div class="flow-arrow-container pt-6"><div class="flow-action-label">Update Grid</div><div class="flow-line"><div class="flow-packet green" style="animation-delay: 1s"></div></div></div><div class="flow-card"><div class="flow-card-title">4. Master</div><i class="fas fa-table text-blue-400 text-2xl my-2"></i><span class="text-[8px] text-slate-400">Live Sheet</span></div></div></div></div>
                        <div id="ds-view-detail" class="hidden"><div class="flex justify-between items-center mb-4"><div><button onclick="closeDataSheet()" class="text-xs text-slate-400 hover:text-white mb-1"><i class="fas fa-arrow-left mr-1"></i> Back to List</button><h3 class="text-xl font-bold text-white" id="ds-title-display">ETF_Data_Master.xlsx</h3><p class="text-xs text-slate-400">Linked Regulation: <strong>Reg 12b</strong></p></div><button onclick="toggleDataEdit()" id="btn-data-edit" class="bg-blue-600 text-white text-xs px-4 py-2 rounded-lg hover:bg-blue-500 transition border border-blue-400"><i class="fas fa-pencil-alt mr-2"></i> Edit Data</button></div><div class="bg-slate-900 border border-slate-700 rounded-lg overflow-hidden relative"><table class="ds-table"><thead><tr><th>ID</th><th>Field Name</th><th>Value (Current)</th><th>Type</th><th>Source</th></tr></thead><tbody><tr><td>001</td><td>Total Assets</td><td><input type="text" value="1,500,000" class="ds-input" readonly></td><td><span class="text-slate-400">Manual</span></td><td>User Input</td></tr><tr><td>002</td><td>Cash Flow</td><td><input type="text" value="200,000" class="ds-input" readonly></td><td><span class="text-slate-400">Manual</span></td><td>User Input</td></tr><tr class="bg-blue-900/10"><td>003</td><td>Risk Weight</td><td class="ds-cell-calc" onclick="showFormula('(Total Assets - Liabilities) * 0.15', 'Reg 12b, Section 4.2')">0.15</td><td><span class="text-blue-400"><i class="fas fa-calculator mr-1"></i> Calculated</span></td><td>Reg 12b (pg. 4)</td></tr><tr class="bg-blue-900/10"><td>004</td><td>Tax Liability</td><td class="ds-cell-calc" onclick="showFormula('(Assets * 0.20)', 'Treasury Tax Code 2024')">300,000</td><td><span class="text-blue-400"><i class="fas fa-calculator mr-1"></i> Calculated</span></td><td>(Assets * 0.2)</td></tr><tr><td>005</td><td>Fund Manager</td><td><input type="text" value="John Doe" class="ds-input" readonly></td><td><span class="text-slate-400">Manual</span></td><td>User Input</td></tr></tbody></table><div id="formula-modal" class="hidden absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-slate-800 border border-blue-500 rounded-lg p-4 shadow-2xl w-64 z-20"><div class="flex justify-between items-start mb-2"><h5 class="text-xs font-bold text-blue-400 uppercase">Formula Logic</h5><button onclick="document.getElementById('formula-modal').classList.add('hidden')" class="text-slate-400 hover:text-white"><i class="fas fa-times"></i></button></div><div class="bg-black/30 p-2 rounded text-xs font-mono text-green-400 mb-2" id="formula-text">= (A1 * 0.5)</div><div class="text-[10px] text-slate-400"><i class="fas fa-book mr-1"></i> Source: <span class="text-slate-200" id="formula-source">Regulation Doc</span></div></div></div></div>
                     </div>
                     
                     <!-- HIDDEN SUB-PAGES -->
                     <div id="ui-page-reports-month" class="hidden"><div class="flex justify-between items-center mb-6"><div class="flex items-center gap-3"><button onclick="openUiPage('dashboard')" class="text-xs text-slate-400 hover:text-white"><i class="fas fa-arrow-left mr-1"></i> Dashboard</button><h3 class="text-xl font-bold text-white">Reports: Current Month</h3></div><span class="bg-blue-900/50 text-blue-300 border border-blue-500/30 text-xs px-2 py-1 rounded">12 Records</span></div><div class="bg-slate-800 rounded-xl overflow-hidden border border-slate-700"><table class="mock-table"><thead><tr class="bg-slate-700/50"><th>Date</th><th>Report Name</th><th>Author</th><th>Status</th><th>Actions</th></tr></thead><tbody><tr><td>Oct 24</td><td class="font-bold text-white">ETF Monthly Summary</td><td>Analyst A</td><td><span class="text-green-400">Submitted</span></td><td><span class="mock-btn-sm btn-blue">View</span></td></tr><tr><td>Oct 22</td><td class="font-bold text-white">Bond Yield Q3</td><td>Analyst B</td><td><span class="text-green-400">Submitted</span></td><td><span class="mock-btn-sm btn-blue">View</span></td></tr><tr><td>Oct 20</td><td class="font-bold text-white">Weekly TASE Update</td><td>Analyst A</td><td><span class="text-green-400">Submitted</span></td><td><span class="mock-btn-sm btn-blue">View</span></td></tr></tbody></table></div></div>
                     <div id="ui-page-audit-pending" class="hidden"><div class="flex justify-between items-center mb-6"><div class="flex items-center gap-3"><button onclick="openUiPage('dashboard')" class="text-xs text-slate-400 hover:text-white"><i class="fas fa-arrow-left mr-1"></i> Dashboard</button><h3 class="text-xl font-bold text-white">Pending Audits Queue</h3></div><span class="bg-yellow-900/50 text-yellow-300 border border-yellow-500/30 text-xs px-2 py-1 rounded">3 Items</span></div><div class="space-y-4"><div class="bg-slate-800 p-4 rounded-xl border-l-4 border-yellow-500 flex justify-between items-center"><div><h4 class="text-white font-bold text-sm">Oct 2024 ETF Report</h4><p class="text-xs text-slate-400">Submitted by: Analyst A  2 hours ago</p></div><button class="bg-yellow-600 text-white text-xs px-4 py-2 rounded hover:bg-yellow-500">Review Now</button></div><div class="bg-slate-800 p-4 rounded-xl border-l-4 border-yellow-500 flex justify-between items-center"><div><h4 class="text-white font-bold text-sm">Real Estate Fund Q3</h4><p class="text-xs text-slate-400">Submitted by: Analyst C  5 hours ago</p></div><button class="bg-yellow-600 text-white text-xs px-4 py-2 rounded hover:bg-yellow-500">Review Now</button></div><div class="bg-slate-800 p-4 rounded-xl border-l-4 border-yellow-500 flex justify-between items-center"><div><h4 class="text-white font-bold text-sm">Tech Sector Overview</h4><p class="text-xs text-slate-400">Submitted by: Analyst B  Yesterday</p></div><button class="bg-yellow-600 text-white text-xs px-4 py-2 rounded hover:bg-yellow-500">Review Now</button></div></div></div>

                 </div>
             </div>
        </div>

        <!-- ========================================== -->
        <!-- TECH VIEW (UPDATED - OPTION A ONLY)        -->
        <!-- ========================================== -->
        <div id="view-tech" class="hidden">
            <h2 class="text-2xl font-bold text-white mb-6 pl-2 border-l-4 border-cyan-500">Technical Deep Dive: Python Enterprise Stack</h2>
            
            <div class="bg-slate-800/40 p-8 rounded-xl border border-slate-700/50 mb-12 relative overflow-hidden">
                 
                 <!-- Layer 1: Frontend -->
                 <div class="flex justify-center mb-8 relative z-10">
                     <div class="bg-slate-900 border border-slate-600 rounded-xl px-6 py-3 flex flex-col items-center gap-2 shadow-lg w-64">
                         <i class="fas fa-laptop text-cyan-400 text-3xl"></i>
                         <div class="text-center">
                             <div class="text-xs text-slate-400 uppercase font-bold">Frontend Application</div>
                             <div class="text-sm text-white font-bold">React + Tailwind</div>
                             <div class="text-[10px] text-slate-500 mt-1">Axios  Recharts  Handsontable</div>
                         </div>
                     </div>
                 </div>

                 <!-- Connector -->
                 <div class="absolute left-1/2 top-24 bottom-24 w-0.5 bg-gradient-to-b from-cyan-500/50 via-blue-500/50 to-purple-500/50 -translate-x-1/2 z-0"></div>

                 <!-- Layer 2: API Gateway & Logic -->
                 <div class="flex justify-center gap-8 mb-8 relative z-10">
                     <!-- API Gateway -->
                     <div class="bg-slate-900 border border-blue-500 rounded-xl p-4 w-64 text-center shadow-lg shadow-blue-500/10">
                         <div class="text-xs font-bold text-blue-300 uppercase mb-2">API Gateway</div>
                         <h4 class="text-white font-bold text-lg mb-1">FastAPI</h4>
                         <p class="text-[10px] text-slate-400 mb-3">Python 3.11+  Pydantic  Async</p>
                         <div class="flex flex-wrap justify-center gap-1">
                             <span class="text-[9px] bg-slate-800 px-2 py-0.5 rounded border border-slate-700">Auth Middleware</span>
                             <span class="text-[9px] bg-slate-800 px-2 py-0.5 rounded border border-slate-700">Rate Limiting</span>
                         </div>
                     </div>
                 </div>
                 
                 <!-- Layer 3: Async Workers (SPLIT) -->
                 <div class="flex justify-center gap-6 mb-8 relative z-10">
                      <!-- Worker: AI -->
                     <div class="bg-slate-900 border-2 border-dashed border-purple-500/30 rounded-xl p-4 w-48 text-center relative">
                         <div class="absolute -top-3 left-1/2 -translate-x-1/2 bg-slate-800 text-[10px] px-2 text-purple-300 border border-purple-500/30 rounded uppercase font-bold">AI Engine</div>
                         <i class="fas fa-brain text-purple-400 text-2xl mb-1"></i>
                         <div class="text-xs font-bold text-white mb-2">LangChain + ChromaDB</div>
                         <p class="text-[9px] text-slate-400 leading-tight">Orchestrates Regulation Diffing & Template Mapping.</p>
                     </div>

                     <!-- Queue -->
                     <div class="flex flex-col justify-center items-center w-24">
                         <div class="bg-slate-800 border border-red-500 rounded p-2 text-center w-full shadow-lg shadow-red-500/10">
                             <i class="fas fa-layer-group text-red-400 text-xl mb-1"></i>
                             <div class="text-[10px] font-bold text-white">Redis / Celery</div>
                             <div class="text-[8px] text-slate-400">Message Broker</div>
                         </div>
                     </div>

                     <!-- Worker: Calc -->
                     <div class="bg-slate-900 border-2 border-dashed border-green-500/30 rounded-xl p-4 w-48 text-center relative">
                         <div class="absolute -top-3 left-1/2 -translate-x-1/2 bg-slate-800 text-[10px] px-2 text-green-300 border border-green-500/30 rounded uppercase font-bold">Calc Engine</div>
                         <i class="fas fa-calculator text-green-400 text-2xl mb-1"></i>
                         <div class="text-xs font-bold text-white mb-2">Pandas / Numpy</div>
                         <p class="text-[9px] text-slate-400 leading-tight">Executes Excel Logic & Financial Formulas.</p>
                     </div>
                 </div>

                 <!-- Layer 4: Data Persistence -->
                 <div class="flex justify-center gap-4 relative z-10">
                     <div class="bg-orange-900/20 border border-orange-500/50 rounded-xl p-4 w-48 text-center">
                         <i class="fas fa-database text-orange-400 text-2xl mb-2"></i>
                         <div class="text-sm font-bold text-white">PostgreSQL</div>
                         <div class="text-[10px] text-slate-400">Supabase Managed</div>
                     </div>
                     <div class="bg-green-900/20 border border-green-500/50 rounded-xl p-4 w-48 text-center">
                         <i class="fas fa-hdd text-green-400 text-2xl mb-2"></i>
                         <div class="text-sm font-bold text-white">S3 Storage</div>
                         <div class="text-[10px] text-slate-400">PDFs & Excel Files</div>
                     </div>
                 </div>

             </div>
        </div>
        
        <!-- ========================================== -->
        <!-- DEPLOYMENT VIEW (UPDATED)                  -->
        <!-- ========================================== -->
        <div id="view-deployment" class="hidden">
            <h2 class="text-2xl font-bold text-white mb-6 pl-2 border-l-4 border-pink-500">Deployment Strategy: CI/CD & Orchestration</h2>
            
            <div class="grid md:grid-cols-3 gap-6 mb-8">
                <!-- Stage 1: Build -->
                <div class="card p-6 bg-slate-900/50 border-t-4 border-blue-500">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-white font-bold">1. Build & Test</h3>
                        <i class="fab fa-github text-2xl text-white"></i>
                    </div>
                    <ul class="text-xs text-slate-400 space-y-3">
                        <li class="flex items-center gap-2"><i class="fas fa-code-branch text-blue-400"></i> <strong>Trigger:</strong> Push to `main`</li>
                        <li class="flex items-center gap-2"><i class="fas fa-vial text-blue-400"></i> <strong>Test:</strong> `pytest` suite runs (Unit + Integ)</li>
                        <li class="flex items-center gap-2"><i class="fas fa-box text-blue-400"></i> <strong>Artifact:</strong> Build Docker Image</li>
                    </ul>
                </div>

                <!-- Stage 2: Registry -->
                <div class="card p-6 bg-slate-900/50 border-t-4 border-purple-500">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-white font-bold">2. Registry</h3>
                        <i class="fab fa-docker text-2xl text-blue-400"></i>
                    </div>
                    <ul class="text-xs text-slate-400 space-y-3">
                        <li class="flex items-center gap-2"><i class="fas fa-shield-alt text-purple-400"></i> <strong>Scan:</strong> Security vuln check</li>
                        <li class="flex items-center gap-2"><i class="fas fa-tag text-purple-400"></i> <strong>Tag:</strong> Versioning (SHA-1)</li>
                        <li class="flex items-center gap-2"><i class="fas fa-cloud-upload-alt text-purple-400"></i> <strong>Push:</strong> GCR / ECR</li>
                    </ul>
                </div>

                <!-- Stage 3: Deploy -->
                <div class="card p-6 bg-slate-900/50 border-t-4 border-green-500">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-white font-bold">3. Runtime</h3>
                        <i class="fas fa-server text-2xl text-green-400"></i>
                    </div>
                     <ul class="text-xs text-slate-400 space-y-3">
                        <li class="flex items-center gap-2"><i class="fas fa-sync text-green-400"></i> <strong>Provider:</strong> Railway / AWS ECS</li>
                        <li class="flex items-center gap-2"><i class="fas fa-network-wired text-green-400"></i> <strong>Routing:</strong> Load Balancer update</li>
                        <li class="flex items-center gap-2"><i class="fas fa-check-double text-green-400"></i> <strong>Health:</strong> `/healthz` probe</li>
                    </ul>
                </div>
            </div>

            <div class="bg-slate-800 p-6 rounded-xl border border-slate-700">
                <h4 class="text-sm font-bold text-white mb-4 uppercase tracking-widest">Environment Strategy</h4>
                <div class="grid grid-cols-2 gap-8 text-xs">
                    <div>
                        <div class="flex items-center gap-2 mb-2 text-yellow-400 font-bold"><i class="fas fa-flask"></i> Staging</div>
                        <p class="text-slate-400 mb-2">Mirror of production. Deploys on PR merge.</p>
                        <div class="bg-slate-900 p-2 rounded border border-slate-600 text-slate-500 font-mono">DB: db_staging (Anonymized)</div>
                    </div>
                    <div>
                        <div class="flex items-center gap-2 mb-2 text-green-400 font-bold"><i class="fas fa-rocket"></i> Production</div>
                        <p class="text-slate-400 mb-2">Live traffic. Deploys on Release Tag.</p>
                        <div class="bg-slate-900 p-2 rounded border border-slate-600 text-slate-500 font-mono">DB: db_prod (Encrypted)</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========================================== -->
        <!-- SECURITY VIEW (UPDATED)                    -->
        <!-- ========================================== -->
        <div id="view-security" class="hidden">
             <h2 class="text-2xl font-bold text-white mb-6 pl-2 border-l-4 border-teal-500">Security Architecture: Defense in Depth</h2>
             
             <div class="space-y-6">
                 <!-- Layer 1 -->
                 <div class="flex gap-4 items-start">
                     <div class="bg-slate-800 p-3 rounded-lg border border-teal-500/30 min-w-[120px] text-center">
                         <i class="fas fa-id-card text-teal-400 text-2xl mb-2"></i>
                         <div class="text-xs font-bold text-white">Identity</div>
                     </div>
                     <div class="flex-grow pt-2">
                         <h4 class="text-white font-bold text-sm">Authentication & Access Control</h4>
                         <p class="text-xs text-slate-400 mt-1">Using <strong>Supabase Auth</strong> (wrapping GoTrue) for handling JWTs.</p>
                         <div class="grid grid-cols-2 gap-4 mt-3">
                             <div class="bg-slate-900 p-2 rounded border-l-2 border-teal-500 text-xs text-slate-300"><strong>MFA:</strong> Enforced for Admin roles.</div>
                             <div class="bg-slate-900 p-2 rounded border-l-2 border-teal-500 text-xs text-slate-300"><strong>Session:</strong> Short-lived Access Tokens (1h).</div>
                         </div>
                     </div>
                 </div>

                 <!-- Layer 2 -->
                 <div class="flex gap-4 items-start">
                     <div class="bg-slate-800 p-3 rounded-lg border border-blue-500/30 min-w-[120px] text-center">
                         <i class="fas fa-code text-blue-400 text-2xl mb-2"></i>
                         <div class="text-xs font-bold text-white">Application</div>
                     </div>
                     <div class="flex-grow pt-2">
                         <h4 class="text-white font-bold text-sm">FastAPI Security Middleware</h4>
                         <p class="text-xs text-slate-400 mt-1">Python-level enforcement of business rules.</p>
                         <ul class="text-xs text-slate-400 list-disc list-inside mt-2 space-y-1">
                             <li><strong>Input Validation:</strong> Pydantic models strictly type-check all incoming JSON.</li>
                             <li><strong>RBAC:</strong> Custom dependency `@requires_role(['admin', 'auditor'])`.</li>
                             <li><strong>Audit Logging:</strong> Middleware captures `User`, `Action`, `Resource` for every write op.</li>
                         </ul>
                     </div>
                 </div>

                 <!-- Layer 3 -->
                 <div class="flex gap-4 items-start">
                     <div class="bg-slate-800 p-3 rounded-lg border border-purple-500/30 min-w-[120px] text-center">
                         <i class="fas fa-server text-purple-400 text-2xl mb-2"></i>
                         <div class="text-xs font-bold text-white">Infrastructure</div>
                     </div>
                     <div class="flex-grow pt-2">
                         <h4 class="text-white font-bold text-sm">Data Protection</h4>
                         <p class="text-xs text-slate-400 mt-1">Encryption at rest and in transit.</p>
                         <ul class="text-xs text-slate-400 list-disc list-inside mt-2 space-y-1">
                             <li><strong>SSL/TLS:</strong> 100% HTTPS via Railway/Cloudflare edge.</li>
                             <li><strong>DB Encryption:</strong> Postgres encryption at rest.</li>
                             <li><strong>Backups:</strong> PITR (Point-in-Time Recovery) enabled for 7 days.</li>
                         </ul>
                     </div>
                 </div>
             </div>
        </div>

        <!-- ========================================== -->
        <!-- COST ANALYSIS VIEW (UPDATED)               -->
        <!-- ========================================== -->
        <div id="view-cost" class="hidden">
            <h2 class="text-2xl font-bold text-white mb-6 pl-2 border-l-4 border-yellow-500">Estimated Monthly Infrastructure Cost</h2>
            <p class="text-slate-400 mb-8 max-w-3xl">Projected operational costs for the Python Enterprise stack (Option A) at MVP scale (~50 Users).</p>

            <div class="grid md:grid-cols-2 gap-8">
                <!-- Breakdown Table -->
                <div class="bg-slate-800 rounded-xl overflow-hidden border border-slate-700">
                    <table class="w-full text-sm text-left text-slate-400">
                        <thead class="text-xs text-slate-200 uppercase bg-slate-900">
                            <tr>
                                <th class="px-6 py-3">Service</th>
                                <th class="px-6 py-3">Tier / Spec</th>
                                <th class="px-6 py-3 text-right">Est. Cost</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="border-b border-slate-700">
                                <td class="px-6 py-4 font-bold text-white">Compute (Railway)</td>
                                <td class="px-6 py-4 text-xs">8GB RAM, 4 vCPU (Shared)</td>
                                <td class="px-6 py-4 text-right text-white font-mono">$40.00</td>
                            </tr>
                            <tr class="border-b border-slate-700">
                                <td class="px-6 py-4 font-bold text-white">Database (Supabase)</td>
                                <td class="px-6 py-4 text-xs">Pro Plan (8GB Disk)</td>
                                <td class="px-6 py-4 text-right text-white font-mono">$25.00</td>
                            </tr>
                            <tr class="border-b border-slate-700">
                                <td class="px-6 py-4 font-bold text-white">Redis (Cache)</td>
                                <td class="px-6 py-4 text-xs">Managed Instance</td>
                                <td class="px-6 py-4 text-right text-white font-mono">$10.00</td>
                            </tr>
                            <tr class="border-b border-slate-700">
                                <td class="px-6 py-4 font-bold text-white">AI API (OpenAI)</td>
                                <td class="px-6 py-4 text-xs">GPT-4o (Usage Based)</td>
                                <td class="px-6 py-4 text-right text-white font-mono">~$50.00</td>
                            </tr>
                            <tr class="border-b border-slate-700">
                                <td class="px-6 py-4 font-bold text-white">Gemini Advanced</td>
                                <td class="px-6 py-4 text-xs">AI Architect Assistant</td>
                                <td class="px-6 py-4 text-right text-white font-mono">$20.00</td>
                            </tr>
                            <tr class="border-b border-slate-700">
                                <td class="px-6 py-4 font-bold text-white">Cursor Pro</td>
                                <td class="px-6 py-4 text-xs">AI Code Editor</td>
                                <td class="px-6 py-4 text-right text-white font-mono">$20.00</td>
                            </tr>
                            <tr class="bg-slate-700/30">
                                <td class="px-6 py-4 font-bold text-yellow-400 uppercase">Total Monthly</td>
                                <td class="px-6 py-4"></td>
                                <td class="px-6 py-4 text-right text-yellow-400 font-bold font-mono text-lg">$165.00</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Context -->
                <div class="space-y-6">
                    <div class="card p-6 border-l-4 border-blue-500">
                        <h4 class="text-sm font-bold text-white mb-2">Scaling Triggers</h4>
                        <p class="text-xs text-slate-400 mb-4">When do we pay more?</p>
                        <ul class="text-xs text-slate-300 space-y-2">
                            <li><i class="fas fa-arrow-up text-red-400 mr-2"></i> <strong>AI Usage:</strong> Heavy PDF parsing volume will increase OpenAI bill linearly.</li>
                            <li><i class="fas fa-arrow-up text-red-400 mr-2"></i> <strong>Storage:</strong> Archiving years of PDFs (>50GB) adds ~$0.02/GB.</li>
                        </ul>
                    </div>
                    <div class="card p-6 border-l-4 border-green-500">
                        <h4 class="text-sm font-bold text-white mb-2">Optimization Opportunities</h4>
                        <p class="text-xs text-slate-400 mb-4">How to save money later.</p>
                        <ul class="text-xs text-slate-300 space-y-2">
                            <li><i class="fas fa-check text-green-400 mr-2"></i> <strong>Local LLMs:</strong> Switch PDF parsing to local Llama 3 on GPU instance (Fixed cost vs API).</li>
                            <li><i class="fas fa-check text-green-400 mr-2"></i> <strong>Reserved Instances:</strong> Commit to 1-year compute for 30% discount.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ========================================== -->
        <!-- MVP PLAN VIEW (UPDATED 8 MONTHS)           -->
        <!-- ========================================== -->
        <div id="view-infographic" class="hidden">
            
            <!-- 1. THE GOLDEN LOOP ROLES -->
            <div class="mb-12">
                <h3 class="text-2xl font-bold text-white mb-6 text-center">The "Golden Loop" Team</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- User -->
                    <div class="bg-slate-800/80 p-6 rounded-xl border-t-4 border-blue-500 text-center shadow-lg relative overflow-hidden group">
                        <div class="absolute top-0 left-0 w-full h-full bg-blue-500/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        <div class="w-16 h-16 mx-auto bg-blue-900/50 rounded-full flex items-center justify-center mb-4 border border-blue-500/30">
                            <i class="fas fa-user-tie text-2xl text-blue-400"></i>
                        </div>
                        <h4 class="text-lg font-bold text-white">Product Owner</h4>
                        <div class="text-xs text-blue-400 font-bold uppercase tracking-wider mb-2">You</div>
                        <p class="text-xs text-slate-400 leading-relaxed">
                            Defines the <strong>Business Logic</strong> and validates the results. You provide the domain expertise (Day Trading/Options) and approve the features.
                        </p>
                    </div>

                    <!-- Gemini -->
                    <div class="bg-slate-800/80 p-6 rounded-xl border-t-4 border-purple-500 text-center shadow-lg relative overflow-hidden group">
                        <div class="absolute top-0 left-0 w-full h-full bg-purple-500/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        <div class="w-16 h-16 mx-auto bg-purple-900/50 rounded-full flex items-center justify-center mb-4 border border-purple-500/30">
                            <i class="fas fa-brain text-2xl text-purple-400"></i>
                        </div>
                        <h4 class="text-lg font-bold text-white">Architect</h4>
                        <div class="text-xs text-purple-400 font-bold uppercase tracking-wider mb-2">Gemini</div>
                        <p class="text-xs text-slate-400 leading-relaxed">
                            Designs the <strong>System Architecture</strong> and writes the "Master Prompts". I remember the context, plan the DB schema, and guide Cursor.
                        </p>
                    </div>

                    <!-- Cursor -->
                    <div class="bg-slate-800/80 p-6 rounded-xl border-t-4 border-green-500 text-center shadow-lg relative overflow-hidden group">
                        <div class="absolute top-0 left-0 w-full h-full bg-green-500/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        <div class="w-16 h-16 mx-auto bg-green-900/50 rounded-full flex items-center justify-center mb-4 border border-green-500/30">
                            <i class="fas fa-code text-2xl text-green-400"></i>
                        </div>
                        <h4 class="text-lg font-bold text-white">Senior Dev</h4>
                        <div class="text-xs text-green-400 font-bold uppercase tracking-wider mb-2">Cursor (AI)</div>
                        <p class="text-xs text-slate-400 leading-relaxed">
                            Executes the <strong>Coding</strong>. Takes my prompts and generates the React/Python/R code, fixes bugs, and handles boilerplates instantly.
                        </p>
                    </div>
                </div>
            </div>

            <!-- 2. 8-MONTH TIMELINE -->
            <div class="glass-card p-8 mb-8">
                <h3 class="text-xl font-bold text-white mb-6 text-center">8-Month Roadmap Execution</h3>
                <div class="chart-container md:h-80 mb-8">
                    <canvas id="timelineChart"></canvas>
                </div>

                <!-- Detailed Text Breakdown -->
                <div class="grid md:grid-cols-2 gap-6 mt-8">
                    <div class="space-y-4">
                        <div class="flex gap-4">
                            <div class="w-12 text-right font-bold text-slate-500 text-xs pt-1">M 1-2</div>
                            <div class="border-l-2 border-slate-700 pl-4 pb-2">
                                <h5 class="text-white font-bold text-sm">Foundation & Architecture</h5>
                                <ul class="text-[10px] text-slate-400 list-disc pl-4 mt-1 space-y-1">
                                    <li><strong>Setup:</strong> Repo, Supabase Auth, Railway PaaS.</li>
                                    <li><strong>Schema:</strong> Define DB for `Users`, `Regulations`, `Reports`, and `DataSheets`.</li>
                                    <li><strong>Ingestion:</strong> Build script to upload previous PDFs and matching Excel Sheets.</li>
                                </ul>
                            </div>
                        </div>
                        <div class="flex gap-4">
                            <div class="w-12 text-right font-bold text-blue-500 text-xs pt-1">M 3-4</div>
                            <div class="border-l-2 border-blue-500 pl-4 pb-2">
                                <h5 class="text-white font-bold text-sm">Core Backend (The Engine)</h5>
                                <ul class="text-[10px] text-slate-400 list-disc pl-4 mt-1 space-y-1">
                                    <li><strong>Reverse Engineering:</strong> Logic to map PDF fields -> Excel Cells (First-Time Setup).</li>
                                    <li><strong>Diff Engine:</strong> Compare new uploaded regulations vs old.</li>
                                    <li><strong>Overwrite Logic:</strong> Auto-fill new templates with Excel data (Recurring).</li>
                                </ul>
                            </div>
                        </div>
                        <div class="flex gap-4">
                            <div class="w-12 text-right font-bold text-purple-500 text-xs pt-1">M 5-6</div>
                            <div class="border-l-2 border-purple-500 pl-4 pb-2">
                                <h5 class="text-white font-bold text-sm">Interactive Frontend</h5>
                                <ul class="text-[10px] text-slate-400 list-disc pl-4 mt-1 space-y-1">
                                    <li><strong>Quick Generate:</strong> Build the "One-Click" dashboard widget.</li>
                                    <li><strong>Data Editor:</strong> Handsontable integration for editing data before signing.</li>
                                    <li><strong>Review Portal:</strong> UI for Auditors to approve reports.</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div class="flex gap-4">
                            <div class="w-12 text-right font-bold text-green-500 text-xs pt-1">M 7</div>
                            <div class="border-l-2 border-green-500 pl-4 pb-2">
                                <h5 class="text-white font-bold text-sm">Security & Audit</h5>
                                <p class="text-xs text-slate-400">Implement Audit Logs (Who changed what?), Role-Based Access Control (Analyst vs Manager), and input validation.</p>
                            </div>
                        </div>
                        <div class="flex gap-4">
                            <div class="w-12 text-right font-bold text-yellow-500 text-xs pt-1">M 8</div>
                            <div class="border-l-2 border-yellow-500 pl-4 pb-2">
                                <h5 class="text-white font-bold text-sm">Polish & Beta</h5>
                                <p class="text-xs text-slate-400">User Acceptance Testing (UAT), bug crushing, documentation, and deploying the production environment.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="glass-card p-8">
                <h3 class="text-xl font-bold text-white mb-6 text-center">Data Complexity</h3>
                <div class="chart-container md:h-64">
                    <canvas id="dbChart"></canvas>
                </div>
            </div>
        </div>

    </main>

    <footer class="text-center text-slate-600 text-sm mt-12 mb-8 border-t border-slate-800 pt-8">
        <p>Investment SaaS MVP Strategy  Generated for Internal Review</p>
    </footer>

    <script>
        // --- Chart.js Initialization for MVP Plan ---
        let timelineChart = null;
        let dbChart = null;

        function initInfographicCharts() {
            if (timelineChart) return; // Already initialized

            const ctxTimeline = document.getElementById('timelineChart').getContext('2d');
            const ctxDB = document.getElementById('dbChart').getContext('2d');
            
            Chart.defaults.color = '#94a3b8';
            Chart.defaults.font.family = 'Inter';

            // UPDATED: 8 Month Timeline Labels
            const phaseLabels = [
                ['Months 1-2', 'Foundation'], 
                ['Months 3-4', 'Backend Core'], 
                ['Months 5-6', 'UI/Frontend'], 
                ['Month 7', 'Security/Audit'], 
                ['Month 8', 'Polish & Launch']
            ];

            timelineChart = new Chart(ctxTimeline, {
                type: 'bar',
                data: {
                    labels: phaseLabels,
                    datasets: [{
                        label: 'Workload Intensity (%)',
                        data: [40, 85, 90, 60, 45], // Intensity curve
                        backgroundColor: [
                            'rgba(148, 163, 184, 0.5)', // Gray (Foundation)
                            'rgba(59, 130, 246, 0.8)',  // Blue (Backend)
                            'rgba(168, 85, 247, 0.8)',  // Purple (Frontend)
                            'rgba(34, 197, 94, 0.8)',   // Green (Security)
                            'rgba(234, 179, 8, 0.8)'    // Yellow (Launch)
                        ],
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#1e293b' }, title: {display: true, text: 'Dev Intensity'} },
                        x: { grid: { display: false } }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: function(tooltipItems) {
                                    const item = tooltipItems[0];
                                    let label = item.chart.data.labels[item.dataIndex];
                                    if (Array.isArray(label)) return label.join(' - ');
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
            
             // 3. Database Structure (Horizontal Bar)
            dbChart = new Chart(ctxDB, {
                type: 'bar',
                data: {
                    labels: ['Users', 'Regulations', 'Templates', 'Data Sheets', 'Reports'],
                    datasets: [{
                        label: 'Fields / Complexity',
                        data: [5, 8, 6, 4, 7],
                        backgroundColor: '#fbbf24',
                        indexAxis: 'y',
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { display: false },
                        y: { grid: { display: false } }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        function switchView(viewName) {
            const views = ['biz-process', 'ui-journey', 'tech', 'deployment', 'risk', 'security', 'cost', 'infographic', 'lifecycle', 'database'];
            
            views.forEach(v => {
                const el = document.getElementById('view-' + v);
                const btn = document.getElementById('btn-' + v);
                
                if (el) {
                    if(v === viewName) {
                        el.style.display = 'block';
                        el.classList.add('fade-in');
                        if (btn) {
                            btn.classList.remove('inactive');
                            btn.classList.add('active');
                        }
                        if (v === 'infographic') {
                            setTimeout(initInfographicCharts, 100);
                        }
                        // SAFEGUARD: If UI Journey is clicked, force Dashboard open to prevent empty screen
                        if (v === 'ui-journey') {
                             setTimeout(() => {
                                 // Check if any sub-page is visible. If not, open dashboard.
                                 const anyVisible = ['dashboard', 'templates', 'reports', 'audit', 'datasheet', 'regulations'].some(p => {
                                     const pEl = document.getElementById('ui-page-' + p);
                                     return pEl && pEl.style.display === 'block';
                                 });
                                 if(!anyVisible) openUiPage('dashboard');
                             }, 50);
                        }
                    } else {
                        el.style.display = 'none';
                        el.classList.remove('fade-in');
                        if (btn) {
                            btn.classList.remove('active');
                            btn.classList.add('inactive');
                        }
                    }
                }
            });
        }

        function openUiPage(pageName) {
            const pages = ['dashboard', 'templates', 'reports', 'audit', 'datasheet', 'regulations', 'reports-month', 'audit-pending'];
            
            pages.forEach(p => {
                const el = document.getElementById('ui-page-' + p);
                if (el) el.style.display = 'none';
                
                const nav = document.getElementById('nav-' + p);
                if (nav) nav.classList.remove('active');
            });

            const targetEl = document.getElementById('ui-page-' + pageName);
            if (targetEl) {
                targetEl.style.display = 'block';
                targetEl.classList.add('fade-in');
            }
            
            if (pageName !== 'reports-month' && pageName !== 'audit-pending') {
                 const targetNav = document.getElementById('nav-' + pageName);
                 if (targetNav) targetNav.classList.add('active');
            }
            
            // Cleanup Logic
            const tList = document.getElementById('template-step-list');
            if(tList) tList.classList.remove('hidden');
            const tWiz = document.getElementById('template-step-wizard');
            if(tWiz) tWiz.classList.add('hidden');
            
            const rList = document.getElementById('report-step-list');
            if(rList) rList.classList.remove('hidden');
            const rWiz = document.getElementById('report-step-wizard');
            if(rWiz) rWiz.classList.add('hidden');
            
            const tHist = document.getElementById('template-history-modal');
            if(tHist) tHist.classList.add('hidden');
            
            const regList = document.getElementById('reg-list-view');
            const regHistory = document.getElementById('reg-history-view');
            const regDiff = document.getElementById('reg-diff-view');
            
            if(regList) regList.classList.remove('hidden');
            if(regHistory) regHistory.classList.add('hidden');
            if(regDiff) regDiff.classList.add('hidden');
            
            const regWiz = document.getElementById('reg-upload-wizard');
            if(regWiz) regWiz.classList.add('hidden');
            
            const tImpact = document.getElementById('template-impact-modal');
            if(tImpact) tImpact.classList.add('hidden');
            
            const rEdit = document.getElementById('report-edit-modal');
            if(rEdit) rEdit.classList.add('hidden');
        }
        
        // Data Sheet Functions
        function openDataSheet(fileName) {
            document.getElementById('ds-view-list').classList.add('hidden');
            document.getElementById('ds-view-detail').classList.remove('hidden');
            document.getElementById('ds-title-display').innerText = fileName;
        }

        function closeDataSheet() {
            document.getElementById('ds-view-detail').classList.add('hidden');
            document.getElementById('ds-view-list').classList.remove('hidden');
        }

        function showFormula(formula, source) {
            const modal = document.getElementById('formula-modal');
            document.getElementById('formula-text').innerText = "= " + formula;
            document.getElementById('formula-source').innerText = source;
            modal.classList.remove('hidden');
        }

        // Data Edit Toggle
        function toggleDataEdit() {
            const btn = document.getElementById('btn-data-edit');
            const inputs = document.querySelectorAll('.ds-input');
            const isEditing = btn.innerText.includes("Save");
            
            if(!isEditing) {
                btn.innerHTML = '<i class="fas fa-save mr-2"></i> Save Changes';
                btn.classList.remove('bg-blue-600', 'hover:bg-blue-500', 'border-blue-400');
                btn.classList.add('bg-green-600', 'hover:bg-green-500', 'border-green-400');
                
                inputs.forEach(inp => {
                    inp.removeAttribute('readonly');
                    inp.classList.add('editing');
                });
            } else {
                btn.innerHTML = '<i class="fas fa-pencil-alt mr-2"></i> Edit Data';
                btn.classList.add('bg-blue-600', 'hover:bg-blue-500', 'border-blue-400');
                btn.classList.remove('bg-green-600', 'hover:bg-green-500', 'border-green-400');
                
                inputs.forEach(inp => {
                    inp.setAttribute('readonly', true);
                    inp.classList.remove('editing');
                });
            }
        }
        
        // Regulation History & Diff Functions
        function openRegHistory(docName) {
            document.getElementById('reg-list-view').classList.add('hidden');
            document.getElementById('reg-history-view').classList.remove('hidden');
            document.getElementById('reg-history-title').innerText = docName;
        }

        function closeRegHistory() {
            document.getElementById('reg-history-view').classList.add('hidden');
            document.getElementById('reg-list-view').classList.remove('hidden');
        }

        function openRegDiff() {
            document.getElementById('reg-history-view').classList.add('hidden');
            document.getElementById('reg-diff-view').classList.remove('hidden');
        }

        function closeRegDiff() {
            document.getElementById('reg-diff-view').classList.add('hidden');
            document.getElementById('reg-history-view').classList.remove('hidden');
        }
        
        // NEW REGULATION UPLOAD WIZARD LOGIC
        function startRegUpload() {
            document.getElementById('reg-upload-wizard').classList.remove('hidden');
            document.getElementById('reg-wiz-upload').classList.remove('hidden');
            document.getElementById('reg-wiz-processing').classList.add('hidden');
            document.getElementById('reg-wiz-success').classList.add('hidden');
            document.getElementById('reg-progress-bar').style.width = '0%';
        }

        function runRegProcessing() {
            document.getElementById('reg-wiz-upload').classList.add('hidden');
            document.getElementById('reg-wiz-processing').classList.remove('hidden');
            
            setTimeout(() => { document.getElementById('reg-progress-bar').style.width = '40%'; }, 500);
            setTimeout(() => { document.getElementById('reg-progress-bar').style.width = '75%'; }, 1500);
            setTimeout(() => { document.getElementById('reg-progress-bar').style.width = '100%'; }, 2500);
            
            setTimeout(() => {
                document.getElementById('reg-wiz-processing').classList.add('hidden');
                document.getElementById('reg-wiz-success').classList.remove('hidden');
            }, 3000);
        }

        function finishRegUpload() {
            cancelRegUpload();
            openRegDiff();
        }

        function cancelRegUpload() {
            document.getElementById('reg-upload-wizard').classList.add('hidden');
        }
        
        // Template Impact Review Functions
        function openTemplateImpact(templateName) {
            const modal = document.getElementById('template-impact-modal');
            if (modal) {
                modal.classList.remove('hidden');
                const titleEl = document.getElementById('impact-template-title');
                if(titleEl) titleEl.innerText = templateName;
            }
        }

        function closeTemplateImpact() {
            const modal = document.getElementById('template-impact-modal');
            if(modal) modal.classList.add('hidden');
        }


        // New Template Wizard Functions
        function startTemplateWizard() {
            document.getElementById('template-step-list').classList.add('hidden');
            document.getElementById('template-step-wizard').classList.remove('hidden');
            document.getElementById('wiz-upload').classList.remove('hidden');
            document.getElementById('wiz-processing').classList.add('hidden');
            document.getElementById('wiz-success').classList.add('hidden');
            
            document.getElementById('ai-progress-bar').style.width = '0%';
        }

        function runAiAnalysis() {
            document.getElementById('wiz-upload').classList.add('hidden');
            document.getElementById('wiz-processing').classList.remove('hidden');
            
            setTimeout(() => { document.getElementById('ai-progress-bar').style.width = '40%'; }, 500);
            setTimeout(() => { document.getElementById('ai-progress-bar').style.width = '75%'; }, 1500);
            setTimeout(() => { document.getElementById('ai-progress-bar').style.width = '100%'; }, 2500);
            
            setTimeout(() => {
                document.getElementById('wiz-processing').classList.add('hidden');
                document.getElementById('wiz-success').classList.remove('hidden');
            }, 3000);
        }

        function finishTemplateWizard() {
             cancelTemplateWizard(); 
        }

        function cancelTemplateWizard() {
            document.getElementById('template-step-wizard').classList.add('hidden');
            document.getElementById('template-step-list').classList.remove('hidden');
        }
        
        // Template History & Activation
        function toggleTemplateHistory() {
            const modal = document.getElementById('template-history-modal');
            if(modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
            } else {
                modal.classList.add('hidden');
            }
        }
        
        function activateTemplate(btn) {
            const row = document.getElementById('draft-template-row');
            const statusCell = document.getElementById('draft-status');
            const actionsCell = document.getElementById('draft-actions');
            
            statusCell.innerHTML = '<span class="text-green-400"> Active</span>';
            btn.remove();
            
            const useBtn = document.createElement('span');
            useBtn.className = 'mock-btn-sm btn-green';
            useBtn.onclick = function() { startReportWizard(); };
            useBtn.innerText = 'Use';
            actionsCell.appendChild(useBtn);
            
            showToast("Template Activated Successfully!");
        }

        // New Report Wizard Functions
        function startReportWizard() {
            document.getElementById('report-step-list').classList.add('hidden');
            document.getElementById('report-step-wizard').classList.remove('hidden');
        }
        
        // MODIFIED: Finish Report Wizard to trigger generation instead of opening Data Sheet
        function finishReportWizard() {
            // Hide wizard
            document.getElementById('report-step-wizard').classList.add('hidden');
            document.getElementById('report-step-list').classList.remove('hidden'); // Show list underneath
            
            // Trigger generation simulation for FIRST TIME report (Draft Status)
            startQuickGenerate('New ETF Report - First Draft', 'Draft'); 
        }

        function cancelReportWizard() {
             document.getElementById('report-step-wizard').classList.add('hidden');
             document.getElementById('report-step-list').classList.remove('hidden');
        }

        // --- NEW: QUICK GENERATE FUNCTIONS ---
        // Added status parameter to handle 'Draft' vs 'Generated'
        function startQuickGenerate(reportName, status = 'Generated') {
            // 1. Show Modal
            const modal = document.getElementById('gen-modal');
            const title = document.getElementById('gen-modal-title');
            modal.classList.remove('hidden');
            
            if(status === 'Draft') {
                title.innerText = "Creating Draft...";
            } else {
                title.innerText = "Generating Report...";
            }
            
            // 2. Animate Bar
            let width = 0;
            const bar = document.getElementById('gen-progress-bar');
            bar.style.width = '0%'; // Reset
            
            const interval = setInterval(() => {
                if (width >= 100) {
                    clearInterval(interval);
                    // Add slight delay before finishing for visual comfort
                    setTimeout(() => {
                        finishQuickGenerate(reportName, status);
                    }, 300);
                } else {
                    width += 2; // Speed of progress
                    bar.style.width = width + '%';
                }
            }, 30); // Update every 30ms
        }

        function finishQuickGenerate(reportName, status) {
            // Hide Modal
            document.getElementById('gen-modal').classList.add('hidden');
            
            // Navigate to Reports Page
            openUiPage('reports');
            
            // Add new row to the table
            const tableBody = document.getElementById('reports-table-body');
            const newRow = document.createElement('tr');
            
            // Get clean name without date if needed
            const displayName = reportName.split(' - ')[0];
            
            // Determine status badge style
            let statusBadge = '';
            let actions = '';
            
            if (status === 'Draft') {
                newRow.classList.add('bg-yellow-900/10', 'border-l-4', 'border-yellow-500', 'fade-in'); 
                statusBadge = `<span class="text-yellow-400 text-[9px] border border-yellow-500 px-1 rounded bg-yellow-900/20">Draft</span>`;
                actions = `<span class="mock-btn-sm btn-purple" onclick="runGeneration(this)">Generate</span><span class="mock-btn-sm btn-blue" onclick="editReportData('${displayName}')">Edit</span><span class="mock-btn-sm btn-red" onclick="requestAction('delete', this)">Delete</span>`;
            } else {
                newRow.classList.add('bg-blue-900/10', 'border-l-4', 'border-blue-500', 'fade-in'); 
                statusBadge = `<span class="text-blue-400 text-[9px] border border-blue-500 px-1 rounded bg-blue-900/20">Generated</span>`;
                actions = `<span class="mock-btn-sm btn-green" onclick="requestAction('submit', this)">Submit</span><span class="mock-btn-sm btn-green" onclick="viewReport('${displayName}')">View</span><span class="mock-btn-sm btn-blue" onclick="editReportData('${displayName}')">Edit</span>`;
            }
            
            newRow.innerHTML = `
                <td class="font-bold text-white py-3">${displayName}</td>
                <td><span class="text-slate-400">Weekly</span></td>
                <td>Today</td>
                <td class="text-green-400">Next Cycle</td>
                <td>${statusBadge}</td>
                <td>${actions}</td>
            `;
            
            // Insert at top
            tableBody.insertBefore(newRow, tableBody.firstChild);
            
            // Increment Total Reports Count
            updateKpi('kpi-reports-count', 1);
        }
        
        // --- STATUS TRANSITIONS ---
        
        function runGeneration(btnElement) {
            const row = btnElement.closest('tr');
            const reportName = row.cells[0].innerText;
            
            // Re-use modal logic but specifically for existing row update
            const modal = document.getElementById('gen-modal');
            document.getElementById('gen-modal-title').innerText = "Processing Logic...";
            modal.classList.remove('hidden');
            
            let width = 0;
            const bar = document.getElementById('gen-progress-bar');
            bar.style.width = '0%'; 
            
            const interval = setInterval(() => {
                if (width >= 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        modal.classList.add('hidden');
                        
                        // Update Row to GENERATED State
                        row.classList.remove('bg-yellow-900/10', 'border-yellow-500');
                        row.classList.add('bg-blue-900/10', 'border-blue-500');
                        row.cells[4].innerHTML = `<span class="text-blue-400 text-[9px] border border-blue-500 px-1 rounded bg-blue-900/20">Generated</span>`;
                        row.cells[5].innerHTML = `<span class="mock-btn-sm btn-green" onclick="requestAction('submit', this)">Submit</span><span class="mock-btn-sm btn-green" onclick="viewReport('${reportName}')">View</span><span class="mock-btn-sm btn-blue" onclick="editReportData('${reportName}')">Edit</span>`;
                        
                        showToast("Report Generated Successfully");
                    }, 300);
                } else {
                    width += 4; 
                    bar.style.width = width + '%';
                }
            }, 30);
        }
        
        // UNIFIED ACTION REQUEST HANDLER
        let pendingAction = null;
        let pendingElement = null;

        function requestAction(actionType, btnElement) {
            pendingAction = actionType;
            pendingElement = btnElement;
            
            const modal = document.getElementById('custom-confirm-modal');
            const icon = document.getElementById('confirm-icon');
            const title = document.getElementById('confirm-title');
            const msg = document.getElementById('confirm-msg');
            const btn = document.getElementById('confirm-btn-action');
            
            if (actionType === 'delete') {
                icon.className = "fas fa-exclamation-triangle text-red-500 text-2xl mb-3";
                title.innerText = "Delete Report?";
                msg.innerText = "This action cannot be undone.";
                btn.className = "px-4 py-2 rounded text-xs bg-red-600 text-white hover:bg-red-500 transition";
                btn.innerText = "Delete";
            } else if (actionType === 'submit') {
                icon.className = "fas fa-check-circle text-green-500 text-2xl mb-3";
                title.innerText = "Submit to Repository?";
                msg.innerText = "This will lock the report for editing.";
                btn.className = "px-4 py-2 rounded text-xs bg-green-600 text-white hover:bg-green-500 transition";
                btn.innerText = "Submit";
            }
            
            modal.classList.remove('hidden');
            
            // Set up onclick for the confirm button
            btn.onclick = function() {
                executeAction();
            };
        }

        function executeAction() {
            if (!pendingAction || !pendingElement) return;
            
            const row = pendingElement.closest('tr');
            
            if (pendingAction === 'delete') {
                row.remove();
                // Decrement Total Reports Count
                updateKpi('kpi-reports-count', -1);
                showToast("Report Deleted.");
            } else if (pendingAction === 'submit') {
                const reportName = row.cells[0].innerText;
                
                // Update visuals
                row.classList.remove('bg-blue-900/10', 'border-blue-500');
                row.classList.add('bg-slate-800'); // Neutral submitted state
                row.cells[4].innerHTML = `<span class="text-green-400 text-[9px] border border-green-500 px-1 rounded bg-green-900/20">Submitted</span>`;
                row.cells[5].innerHTML = `<span class="mock-btn-sm btn-green" onclick="viewReport('${reportName}')">View</span>`;
                
                // Increment Pending Audit Count
                updateKpi('kpi-audit-count', 1);
                
                showToast("Report Submitted Successfully");
            }
            
            closeConfirmModal();
        }
        
        function closeConfirmModal() {
            document.getElementById('custom-confirm-modal').classList.add('hidden');
            pendingAction = null;
            pendingElement = null;
        }
        
        // --- NEW: UI INTERACTION FUNCTIONS (No Alerts) ---
        
        function showToast(msg) {
            const toast = document.getElementById('toast-notification');
            toast.innerText = msg;
            toast.style.display = 'block';
            
            // Fade In
            setTimeout(() => { toast.style.opacity = '1'; }, 10);
            
            // Fade Out & Hide
            setTimeout(() => { 
                toast.style.opacity = '0'; 
                setTimeout(() => { toast.style.display = 'none'; }, 300);
            }, 3000);
        }
        
        function editReportData(reportName) {
            showToast(`Opening Document Editor: ${reportName}`);
            
            // Setup Editor
            const modal = document.getElementById('report-edit-modal');
            const titleEl = document.getElementById('edit-fund-name');
            if(titleEl) titleEl.innerText = reportName;
            
            modal.classList.remove('hidden');
        }
        
        function saveReportChanges() {
            showToast("Changes Saved to Document.");
            closeReportEditor();
        }
        
        function closeReportEditor() {
            const modal = document.getElementById('report-edit-modal');
            modal.classList.add('hidden');
        }
        
        function viewReport(reportName) {
            const modal = document.getElementById('report-view-modal');
            const titleEl = document.getElementById('report-preview-title');
            const fundEl = document.getElementById('prev-fund-name');
            
            titleEl.innerText = `Preview: ${reportName}`;
            fundEl.innerText = reportName;
            
            modal.classList.remove('hidden');
        }
        
        // Helper to update KPI with animation
        function updateKpi(elementId, change) {
            const el = document.getElementById(elementId);
            if (el) {
                let currentVal = parseInt(el.innerText);
                el.innerText = currentVal + change;
                
                // Trigger animation
                el.classList.remove('kpi-update');
                void el.offsetWidth; // Trigger reflow
                el.classList.add('kpi-update');
            }
        }

        // Init view
        switchView('biz-process');
    </script>
</body>
</html>